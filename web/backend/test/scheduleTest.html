<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMS - Test Schedule API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .schedule-container {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .schedule-table {
            width: 100%;
            margin-top: 15px;
        }
        .schedule-table th {
            background-color: #f0f0f0;
        }
        .schedule-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .schedule-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        .period-label {
            font-weight: bold;
            color: #007bff;
        }
        .subject-name {
            font-weight: bold;
        }
        .teacher-name {
            color: #555;
            font-style: italic;
        }
        .room-info {
            color: #28a745;
        }
        .time-info {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">FAMS - Test Schedule API</h1>
        
        <!-- Login Form -->
        <div id="loginSection" class="login-form">
            <h3 class="mb-3">Đăng Nhập</h3>
            <div class="mb-3">
                <label for="userId" class="form-label">User ID</label>
                <input type="text" class="form-control" id="userId" placeholder="Nhập tên đăng nhập">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Mật khẩu</label>
                <input type="password" class="form-control" id="password" placeholder="Mật khẩu">
            </div>
            <button id="loginBtn" class="btn btn-primary w-100">Đăng Nhập</button>
            <div id="loginError" class="alert alert-danger mt-3 hidden"></div>
        </div>
        
        <!-- Schedule Container -->
        <div id="scheduleSection" class="schedule-container hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Thời Khóa Biểu</h3>
                <button id="logoutBtn" class="btn btn-outline-danger">Đăng Xuất</button>
            </div>
            
            <!-- User Info -->
            <div id="userInfo" class="alert alert-info mb-3"></div>
            
            <!-- Schedule Tabs -->
            <ul class="nav nav-tabs" id="scheduleTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">Hôm nay</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tomorrow-tab" data-bs-toggle="tab" data-bs-target="#tomorrow" type="button" role="tab">Ngày mai</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab">Tuần</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="semester-tab" data-bs-toggle="tab" data-bs-target="#semester" type="button" role="tab">Học kỳ</button>
                </li>
            </ul>
            
            <!-- Schedule Content -->
            <div class="tab-content" id="scheduleTabContent">
                <!-- Daily Schedule -->
                <div class="tab-pane fade show active" id="daily" role="tabpanel">
                    <div id="dailyInfo" class="schedule-info"></div>
                    <div id="dailySchedule">
                        <div class="text-center py-5" id="dailyLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                        <div id="dailyContent"></div>
                    </div>
                </div>
                
                <!-- Tomorrow Schedule -->
                <div class="tab-pane fade" id="tomorrow" role="tabpanel">
                    <div id="tomorrowInfo" class="schedule-info"></div>
                    <div id="tomorrowSchedule">
                        <div class="text-center py-5" id="tomorrowLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                        <div id="tomorrowContent"></div>
                    </div>
                </div>
                
                <!-- Weekly Schedule -->
                <div class="tab-pane fade" id="weekly" role="tabpanel">
                    <div id="weeklyInfo" class="schedule-info"></div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select id="weekSelect" class="form-select">
                                <option value="1">Tuần 1</option>
                                <option value="2">Tuần 2</option>
                                <!-- Các tuần khác sẽ được thêm bằng JS -->
                            </select>
                        </div>
                    </div>
                    <div id="weeklySchedule">
                        <div class="text-center py-5" id="weeklyLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                        <table class="table table-bordered schedule-table" id="weeklyTable">
                            <thead>
                                <tr>
                                    <th>Tiết/Thứ</th>
                                    <th>Thứ 2</th>
                                    <th>Thứ 3</th>
                                    <th>Thứ 4</th>
                                    <th>Thứ 5</th>
                                    <th>Thứ 6</th>
                                    <th>Thứ 7</th>
                                </tr>
                            </thead>
                            <tbody id="weeklyTableBody">
                                <!-- Table content will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Semester Schedule -->
                <div class="tab-pane fade" id="semester" role="tabpanel">
                    <div id="semesterInfo" class="schedule-info"></div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select id="semesterSelect" class="form-select">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="semesterSchedule">
                        <div class="text-center py-5" id="semesterLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                        <div id="semesterContent" class="accordion"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API URL
        const API_URL = 'http://localhost:3000';
        
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const scheduleSection = document.getElementById('scheduleSection');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');
        const userInfo = document.getElementById('userInfo');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        
        // Schedule Elements
        const dailyInfo = document.getElementById('dailyInfo');
        const dailyContent = document.getElementById('dailyContent');
        const tomorrowInfo = document.getElementById('tomorrowInfo');
        const tomorrowContent = document.getElementById('tomorrowContent');
        const weeklyInfo = document.getElementById('weeklyInfo');
        const weeklyTableBody = document.getElementById('weeklyTableBody');
        const weekSelect = document.getElementById('weekSelect');
        const semesterInfo = document.getElementById('semesterInfo');
        const semesterContent = document.getElementById('semesterContent');
        const semesterSelect = document.getElementById('semesterSelect');
        
        // Loading Elements
        const dailyLoading = document.getElementById('dailyLoading');
        const tomorrowLoading = document.getElementById('tomorrowLoading');
        const weeklyLoading = document.getElementById('weeklyLoading');
        const semesterLoading = document.getElementById('semesterLoading');
        
        // Global Variables
        let currentUser = null;
        let authToken = null;
        let currentSemester = null;
        let currentWeek = 1;
        
        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        weekSelect.addEventListener('change', loadWeeklySchedule);
        semesterSelect.addEventListener('change', loadSemesterSchedule);
        
        // Tab Listeners
        document.getElementById('daily-tab').addEventListener('click', () => loadDailySchedule('today'));
        document.getElementById('tomorrow-tab').addEventListener('click', () => loadDailySchedule('tomorrow'));
        document.getElementById('weekly-tab').addEventListener('click', loadWeeklySchedule);
        document.getElementById('semester-tab').addEventListener('click', loadSemesterSchedule);
        
        // Check if user is already logged in
        initializeApp();
        
        // Functions
        async function initializeApp() {
            // Check for saved token
            authToken = localStorage.getItem('authToken');
            if (authToken) {
                try {
                    // Get user info to validate token
                    const response = await fetch(`${API_URL}/api/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            currentUser = data.data;
                            showScheduleSection();
                            // Load initial data
                            await loadCurrentSemester();
                            loadDailySchedule('today');
                        } else {
                            handleLogout();
                        }
                    } else {
                        handleLogout();
                    }
                } catch (error) {
                    console.error('Error checking auth:', error);
                    handleLogout();
                }
            }
        }
        
        async function handleLogin() {
            loginError.classList.add('hidden');
            
            const userId = userIdInput.value.trim();
            const password = passwordInput.value;
            
            if (!userId || !password) {
                showLoginError('Vui lòng nhập tên đăng nhập và mật khẩu');
                return;
            }
            
            console.log('Đang đăng nhập với:', { userId });
            
            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, password })
                });
                
                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    // Save token and user info
                    authToken = data.data.accessToken;
                    currentUser = data.data;
                    localStorage.setItem('authToken', authToken);
                    console.log('Đăng nhập thành công:', currentUser);
                    
                    // Show schedule section
                    showScheduleSection();
                    
                    // Load initial data
                    await loadCurrentSemester();
                    loadDailySchedule('today');
                } else {
                    showLoginError(data.message || 'Đăng nhập thất bại');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Lỗi kết nối đến server');
            }
        }
        
        function handleLogout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            showLoginSection();
        }
        
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }
        
        function showLoginSection() {
            loginSection.classList.remove('hidden');
            scheduleSection.classList.add('hidden');
        }
        
        function showScheduleSection() {
            loginSection.classList.add('hidden');
            scheduleSection.classList.remove('hidden');
            
            // Update user info
            if (currentUser) {
                userInfo.textContent = `Đăng nhập với tài khoản: ${currentUser.name || currentUser.userId} (${currentUser.role})`;
            }
        }
        
        async function loadCurrentSemester() {
            try {
                // First get current semester
                const currentResponse = await fetch(`${API_URL}/api/schedules/semester/current`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (currentResponse.ok) {
                    const currentData = await currentResponse.json();
                    if (currentData.success) {
                        currentSemester = currentData.data;
                        currentWeek = currentSemester.currentWeek || 1;
                    }
                }

                // Then get all semesters
                const allSemestersResponse = await fetch(`${API_URL}/api/schedules/semesters`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (allSemestersResponse.ok) {
                    const data = await allSemestersResponse.json();
                    if (data.success && data.data && data.data.length > 0) {
                        // Update semester select
                        semesterSelect.innerHTML = '';
                        data.data.forEach(semester => {
                            const option = document.createElement('option');
                            option.value = semester.semesterId;
                            option.textContent = semester.semesterName;
                            if (currentSemester && semester.semesterId === currentSemester.semesterId) {
                                option.selected = true;
                            }
                            semesterSelect.appendChild(option);
                        });
                        
                        // Update week select (populate 18 weeks for a typical semester)
                        weekSelect.innerHTML = '';
                        for (let i = 1; i <= 18; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = `Tuần ${i}`;
                            if (i === currentWeek) {
                                option.selected = true;
                            }
                            weekSelect.appendChild(option);
                        }
                        
                        return currentSemester;
                    }
                }
            } catch (error) {
                console.error('Error loading semesters:', error);
            }
            return null;
        }
        
        async function loadDailySchedule(date = 'today') {
            // Show loading
            if (date === 'today') {
                dailyLoading.classList.remove('hidden');
                dailyContent.innerHTML = '';
            } else {
                tomorrowLoading.classList.remove('hidden');
                tomorrowContent.innerHTML = '';
            }
            
            try {
                const response = await fetch(`${API_URL}/api/schedules/daily/${date}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update info section
                    const infoElement = date === 'today' ? dailyInfo : tomorrowInfo;
                    infoElement.innerHTML = `
                        <strong>Ngày:</strong> ${data.meta.date} (${data.meta.dayOfWeek}) | 
                        <strong>Tuần:</strong> ${data.meta.weekNumber} | 
                        <strong>Học kỳ:</strong> ${data.meta.semesterName}
                    `;
                    
                    // Update content
                    const contentElement = date === 'today' ? dailyContent : tomorrowContent;
                    
                    if (data.data && data.data.length > 0) {
                        let html = '';
                        data.data.forEach(schedule => {
                            html += `
                                <div class="schedule-item">
                                    <div class="period-label">Tiết ${schedule.period}</div>
                                    <div class="subject-name">${schedule.subject ? schedule.subject.name : 'Không có môn học'}</div>
                                    <div class="teacher-name">GV: ${schedule.teacher ? schedule.teacher.name : 'Chưa phân công'}</div>
                                    <div class="room-info">Phòng: ${schedule.classroom ? schedule.classroom.room : 'Chưa phân công'}</div>
                                    <div class="time-info">${schedule.startTime} - ${schedule.endTime}</div>
                                </div>
                            `;
                        });
                        contentElement.innerHTML = html;
                    } else {
                        contentElement.innerHTML = '<div class="alert alert-warning">Không có lịch học</div>';
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Không thể tải thời khóa biểu');
                }
            } catch (error) {
                const contentElement = date === 'today' ? dailyContent : tomorrowContent;
                contentElement.innerHTML = `<div class="alert alert-danger">Lỗi: ${error.message}</div>`;
                console.error('Error loading daily schedule:', error);
            } finally {
                // Hide loading
                if (date === 'today') {
                    dailyLoading.classList.add('hidden');
                } else {
                    tomorrowLoading.classList.add('hidden');
                }
            }
        }
        
        async function loadWeeklySchedule() {
            // Show loading
            weeklyLoading.classList.remove('hidden');
            weeklyTableBody.innerHTML = '';
            
            const week = weekSelect.value;
            
            try {
                const response = await fetch(`${API_URL}/api/schedules/weekly?week=${week}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update info section
                    weeklyInfo.innerHTML = `
                        <strong>Tuần:</strong> ${data.meta.weekNumber} | 
                        <strong>Học kỳ:</strong> ${data.meta.semesterName} | 
                        <strong>Từ ngày:</strong> ${new Date(data.meta.startDate).toLocaleDateString('vi-VN')}
                    `;
                    
                    // Create weekly table
                    const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const periodMap = {};
                    
                    // Find all periods
                    weekdays.forEach(day => {
                        if (data.data[day]) {
                            data.data[day].forEach(slot => {
                                periodMap[slot.period] = true;
                            });
                        }
                    });
                    
                    // Sort periods
                    const periods = Object.keys(periodMap).map(Number).sort((a, b) => a - b);
                    
                    // Create table rows
                    periods.forEach(period => {
                        const row = document.createElement('tr');
                        
                        // Add period column
                        const periodCell = document.createElement('td');
                        periodCell.textContent = `Tiết ${period}`;
                        periodCell.style.fontWeight = 'bold';
                        row.appendChild(periodCell);
                        
                        // Add weekday columns
                        weekdays.forEach(day => {
                            const cell = document.createElement('td');
                            
                            // Find class for this period and day
                            const slot = data.data[day]?.find(s => s.period === period);
                            
                            if (slot) {
                                cell.innerHTML = `
                                    <div class="subject-name">${slot.subject ? slot.subject.name : ''}</div>
                                    <div class="teacher-name">${slot.teacher ? slot.teacher.name : ''}</div>
                                    <div class="room-info">${slot.classroom ? slot.classroom.room : ''}</div>
                                `;
                            }
                            
                            row.appendChild(cell);
                        });
                        
                        weeklyTableBody.appendChild(row);
                    });
                    
                    if (periods.length === 0) {
                        weeklyTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-3">Không có lịch học trong tuần này</td>
                            </tr>
                        `;
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Không thể tải thời khóa biểu tuần');
                }
            } catch (error) {
                weeklyTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-3 text-danger">Lỗi: ${error.message}</td>
                    </tr>
                `;
                console.error('Error loading weekly schedule:', error);
            } finally {
                // Hide loading
                weeklyLoading.classList.add('hidden');
            }
        }
        
        async function loadSemesterSchedule() {
            // Show loading
            semesterLoading?.classList.remove('hidden');
            semesterContent.innerHTML = '';
            
            const semesterId = semesterSelect.value;
            
            try {
                const response = await fetch(`${API_URL}/api/schedules/semester/${semesterId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update info section
                    semesterInfo.innerHTML = `
                        <strong>Học kỳ:</strong> ${data.meta.semesterName} | 
                        <strong>Thời gian:</strong> ${new Date(data.meta.startDate).toLocaleDateString('vi-VN')} - 
                        ${new Date(data.meta.endDate).toLocaleDateString('vi-VN')}
                    `;
                    
                    // Create accordion for each week
                    const weeks = Object.keys(data.data).sort((a, b) => Number(a) - Number(b));
                    
                    if (weeks.length > 0) {
                        let html = '';
                        
                        weeks.forEach((week, index) => {
                            const weekData = data.data[week];
                            const hasSchedule = Object.values(weekData).some(day => day.length > 0);
                            
                            if (hasSchedule) {
                                html += `
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#week${week}">
                                                Tuần ${week}
                                            </button>
                                        </h2>
                                        <div id="week${week}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}">
                                            <div class="accordion-body">
                                                <div class="row">
                                `;
                                
                                // Add each day
                                const dayNames = {
                                    'Monday': 'Thứ 2',
                                    'Tuesday': 'Thứ 3',
                                    'Wednesday': 'Thứ 4',
                                    'Thursday': 'Thứ 5',
                                    'Friday': 'Thứ 6',
                                    'Saturday': 'Thứ 7',
                                    'Sunday': 'Chủ nhật'
                                };
                                
                                Object.keys(weekData).forEach(day => {
                                    if (weekData[day].length > 0) {
                                        html += `
                                            <div class="col-md-6 mb-3">
                                                <h5>${dayNames[day] || day}</h5>
                                        `;
                                        
                                        // Sort by period
                                        weekData[day].sort((a, b) => a.period - b.period);
                                        
                                        weekData[day].forEach(slot => {
                                            html += `
                                                <div class="schedule-item">
                                                    <div class="period-label">Tiết ${slot.period}</div>
                                                    <div class="subject-name">${slot.subject ? slot.subject.name : 'Không có môn học'}</div>
                                                    <div class="teacher-name">GV: ${slot.teacher ? slot.teacher.name : 'Chưa phân công'}</div>
                                                    <div class="room-info">Phòng: ${slot.classroom ? slot.classroom.room : 'Chưa phân công'}</div>
                                                    <div class="time-info">${slot.startTime} - ${slot.endTime}</div>
                                                </div>
                                            `;
                                        });
                                        
                                        html += `</div>`; // close col
                                    }
                                });
                                
                                html += `
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        semesterContent.innerHTML = html || '<div class="alert alert-warning">Không có lịch học trong học kỳ này</div>';
                    } else {
                        semesterContent.innerHTML = '<div class="alert alert-warning">Không có lịch học trong học kỳ này</div>';
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Không thể tải thời khóa biểu học kỳ');
                }
            } catch (error) {
                semesterContent.innerHTML = `<div class="alert alert-danger">Lỗi: ${error.message}</div>`;
                console.error('Error loading semester schedule:', error);
            } finally {
                // Hide loading
                semesterLoading?.classList.add('hidden');
            }
        }
    </script>
</body>
</html> 