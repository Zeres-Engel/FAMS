<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .endpoint { font-family: monospace; color: #0d6efd; }
        .json-editor { height: 150px; width: 100%; font-family: monospace; }
        .response-area { min-height: 100px; }
        .api-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
        .api-title { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .sticky-top { top: 1rem; }
        .status-bar { font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">API Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Student API</li>
            </ol>
        </nav>
        
        <div class="alert alert-info mb-3">
            <h5>Thông tin API Học sinh</h5>
            <p class="mb-0">API dành cho học sinh: xem thông tin cá nhân, lịch học, điểm số, và thông tin lớp học.</p>
        </div>
        
        <!-- Status bar for authentication info -->
        <div class="card mb-4">
            <div class="card-body status-bar">
                <div class="row">
                    <div class="col-md-6" id="authStatus">
                        <span class="badge bg-warning">Chưa đăng nhập</span>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="checkAuthBtn" class="btn btn-sm btn-info">Kiểm tra xác thực</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile API -->
        <div class="api-section" id="profile-section">
            <div class="api-title">
                <h3>Thông tin cá nhân</h3>
                <span class="endpoint">GET /api/students/profile</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Lấy thông tin cá nhân
                        </div>
                        <div class="card-body">
                            <p>Lấy thông tin cá nhân của học sinh đã đăng nhập.</p>
                            <button id="getProfileBtn" class="btn btn-primary">Lấy thông tin</button>
                            
                            <div class="mt-3 response-area" id="profile-response-message">
                                <!-- Profile response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            API Details
                        </div>
                        <div class="card-body">
                            <p>Gọi API với token hiện tại:</p>
                            <pre>GET /api/students/profile
Authorization: Bearer {token}</pre>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="profile-response" class="response-area">// Kết quả API thông tin cá nhân sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Update Profile API -->
        <div class="api-section" id="update-profile-section">
            <div class="api-title">
                <h3>Cập nhật thông tin cá nhân</h3>
                <span class="endpoint">PUT /api/students/profile</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            Form cập nhật thông tin
                        </div>
                        <div class="card-body">
                            <form id="updateProfileForm">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="phone">
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Địa chỉ</label>
                                    <textarea class="form-control" id="address" rows="2"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success">Cập nhật thông tin</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="update-profile-response-message">
                                <!-- Update Profile response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="update-profile-json" class="json-editor">{
  "phoneNumber": "0123456789",
  "address": "123 Đường ABC, Quận XYZ, TP. Hồ Chí Minh"
}</textarea>
                            <button id="update-profile-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="update-profile-response" class="response-area">// Kết quả API cập nhật thông tin sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule API -->
        <div class="api-section" id="schedule-section">
            <div class="api-title">
                <h3>Lịch học</h3>
                <span class="endpoint">GET /api/schedules/student</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Lấy lịch học
                        </div>
                        <div class="card-body">
                            <form id="getScheduleForm">
                                <div class="mb-3">
                                    <label for="dateFrom" class="form-label">Từ ngày</label>
                                    <input type="date" class="form-control" id="dateFrom">
                                </div>
                                <div class="mb-3">
                                    <label for="dateTo" class="form-label">Đến ngày</label>
                                    <input type="date" class="form-control" id="dateTo">
                                </div>
                                <button type="submit" class="btn btn-info">Lấy lịch học</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="schedule-response-message">
                                <!-- Schedule response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="schedule-json" class="json-editor">{
  "dateFrom": "2023-09-01",
  "dateTo": "2023-09-30"
}</textarea>
                            <button id="schedule-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="schedule-response" class="response-area">// Kết quả API lịch học sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Grades API -->
        <div class="api-section" id="grades-section">
            <div class="api-title">
                <h3>Điểm số</h3>
                <span class="endpoint">GET /api/students/grades</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            Lấy điểm số
                        </div>
                        <div class="card-body">
                            <form id="getGradesForm">
                                <div class="mb-3">
                                    <label for="semester" class="form-label">Học kỳ (tùy chọn)</label>
                                    <select class="form-select" id="semester">
                                        <option value="">Tất cả</option>
                                        <option value="current">Học kỳ hiện tại</option>
                                        <option value="1-2023-2024">Học kỳ 1 năm 2023-2024</option>
                                        <option value="2-2023-2024">Học kỳ 2 năm 2023-2024</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-warning">Lấy điểm số</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="grades-response-message">
                                <!-- Grades response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="grades-json" class="json-editor">{
  "semester": "current"
}</textarea>
                            <button id="grades-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="grades-response" class="response-area">// Kết quả API điểm số sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Class Info API -->
        <div class="api-section" id="class-info-section">
            <div class="api-title">
                <h3>Thông tin lớp học</h3>
                <span class="endpoint">GET /api/students/class</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            Lấy thông tin lớp học
                        </div>
                        <div class="card-body">
                            <p>Lấy thông tin chi tiết về lớp học hiện tại của học sinh.</p>
                            <button id="getClassInfoBtn" class="btn btn-danger">Lấy thông tin lớp</button>
                            
                            <div class="mt-3 response-area" id="class-info-response-message">
                                <!-- Class Info response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            API Details
                        </div>
                        <div class="card-body">
                            <p>Gọi API với token hiện tại:</p>
                            <pre>GET /api/students/class
Authorization: Bearer {token}</pre>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="class-info-response" class="response-area">// Kết quả API thông tin lớp học sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auth state management
        let token = localStorage.getItem('auth_token') || '';
        let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
        const baseUrl = window.location.origin;
        
        // Display formatted response message
        function displayResponseMessage(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            
            if (isSuccess) {
                element.innerHTML = `<div class="alert alert-success">${data}</div>`;
            } else {
                element.innerHTML = `<div class="alert alert-danger">${data}</div>`;
            }
        }
        
        // Display raw JSON response
        function displayRawResponse(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }
        
        // Log to console for debugging
        function logDebug(message, data) {
            console.log(`DEBUG - ${message}:`, data);
        }
        
        // Update authentication status display
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            
            if (token && currentUser) {
                authStatus.innerHTML = `
                    <span class="badge bg-success">Đã đăng nhập</span>
                    <span class="ms-2">Người dùng: <strong>${currentUser.name || currentUser.userId}</strong> (${currentUser.role})</span>
                `;
            } else {
                authStatus.innerHTML = `
                    <span class="badge bg-warning">Chưa đăng nhập</span>
                    <a href="auth.html" class="ms-2 btn btn-sm btn-outline-primary">Đăng nhập</a>
                `;
            }
        }
        
        // Initialize
        updateAuthStatus();
        
        // Sync form with JSON
        function syncFormToJson(formId, jsonId, getDataFn) {
            const form = document.getElementById(formId);
            form.addEventListener('input', () => {
                const jsonData = getDataFn();
                document.getElementById(jsonId).value = JSON.stringify(jsonData, null, 2);
            });
        }
        
        // Check authentication
        document.getElementById('checkAuthBtn').addEventListener('click', async () => {
            if (!token) {
                alert('Bạn chưa đăng nhập! Vui lòng đăng nhập trước.');
                return;
            }
            
            try {
                const response = await fetch(`${baseUrl}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                alert(data.success 
                    ? `Đã xác thực: ${data.data?.name || data.data?.userId} (${data.data?.role})` 
                    : 'Xác thực thất bại: ' + data.message);
            } catch (error) {
                alert('Lỗi kiểm tra xác thực: ' + error.message);
            }
        });
        
        // Profile API functions
        async function executeGetProfile() {
            try {
                if (!token) {
                    displayResponseMessage('profile-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('profile-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/students/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Profile response', data);
                
                // Display raw response
                displayRawResponse('profile-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('profile-response-message', 'Lấy thông tin cá nhân thành công!', true);
                } else {
                    displayResponseMessage('profile-response-message', data.message || 'Lấy thông tin thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Profile error', error);
                displayRawResponse('profile-response', { error: error.message });
                displayResponseMessage('profile-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Update Profile API functions
        function getUpdateProfileData() {
            return {
                phoneNumber: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };
        }
        
        async function executeUpdateProfile(payload) {
            try {
                if (!token) {
                    displayResponseMessage('update-profile-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('update-profile-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/students/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: typeof payload === 'string' ? payload : JSON.stringify(payload)
                });
                
                const data = await response.json();
                logDebug('Update profile response', data);
                
                // Display raw response
                displayRawResponse('update-profile-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('update-profile-response-message', 'Cập nhật thông tin thành công!', true);
                } else {
                    displayResponseMessage('update-profile-response-message', data.message || 'Cập nhật thông tin thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Update profile error', error);
                displayRawResponse('update-profile-response', { error: error.message });
                displayResponseMessage('update-profile-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Schedule API functions
        function getScheduleData() {
            return {
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value
            };
        }
        
        async function executeGetSchedule(payload) {
            try {
                if (!token) {
                    displayResponseMessage('schedule-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('schedule-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                let url = `${baseUrl}/api/schedules/student`;
                if (payload && (payload.dateFrom || payload.dateTo)) {
                    const params = new URLSearchParams();
                    if (payload.dateFrom) params.append('dateFrom', payload.dateFrom);
                    if (payload.dateTo) params.append('dateTo', payload.dateTo);
                    url += `?${params.toString()}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Schedule response', data);
                
                // Display raw response
                displayRawResponse('schedule-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('schedule-response-message', 'Lấy lịch học thành công!', true);
                } else {
                    displayResponseMessage('schedule-response-message', data.message || 'Lấy lịch học thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Schedule error', error);
                displayRawResponse('schedule-response', { error: error.message });
                displayResponseMessage('schedule-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Grades API functions
        function getGradesData() {
            return {
                semester: document.getElementById('semester').value
            };
        }
        
        async function executeGetGrades(payload) {
            try {
                if (!token) {
                    displayResponseMessage('grades-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('grades-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                let url = `${baseUrl}/api/students/grades`;
                if (payload && payload.semester) {
                    url += `?semester=${payload.semester}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Grades response', data);
                
                // Display raw response
                displayRawResponse('grades-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('grades-response-message', 'Lấy điểm số thành công!', true);
                } else {
                    displayResponseMessage('grades-response-message', data.message || 'Lấy điểm số thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Grades error', error);
                displayRawResponse('grades-response', { error: error.message });
                displayResponseMessage('grades-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Class Info API functions
        async function executeGetClassInfo() {
            try {
                if (!token) {
                    displayResponseMessage('class-info-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('class-info-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/students/class`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Class info response', data);
                
                // Display raw response
                displayRawResponse('class-info-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('class-info-response-message', 'Lấy thông tin lớp học thành công!', true);
                } else {
                    displayResponseMessage('class-info-response-message', data.message || 'Lấy thông tin lớp học thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Class info error', error);
                displayRawResponse('class-info-response', { error: error.message });
                displayResponseMessage('class-info-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Setup event listeners
        
        // Profile
        document.getElementById('getProfileBtn').addEventListener('click', async () => {
            await executeGetProfile();
        });
        
        // Update Profile
        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeUpdateProfile(getUpdateProfileData());
        });
        
        document.getElementById('update-profile-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('update-profile-json').value);
                await executeUpdateProfile(jsonData);
            } catch (error) {
                displayResponseMessage('update-profile-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('update-profile-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Schedule
        document.getElementById('getScheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeGetSchedule(getScheduleData());
        });
        
        document.getElementById('schedule-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('schedule-json').value);
                await executeGetSchedule(jsonData);
            } catch (error) {
                displayResponseMessage('schedule-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('schedule-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Grades
        document.getElementById('getGradesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeGetGrades(getGradesData());
        });
        
        document.getElementById('grades-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('grades-json').value);
                await executeGetGrades(jsonData);
            } catch (error) {
                displayResponseMessage('grades-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('grades-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Class Info
        document.getElementById('getClassInfoBtn').addEventListener('click', async () => {
            await executeGetClassInfo();
        });
        
        // Sync forms to JSON
        syncFormToJson('updateProfileForm', 'update-profile-json', getUpdateProfileData);
        syncFormToJson('getScheduleForm', 'schedule-json', getScheduleData);
        syncFormToJson('getGradesForm', 'grades-json', getGradesData);
    </script>
</body>
</html> 