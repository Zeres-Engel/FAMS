<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .endpoint { font-family: monospace; color: #0d6efd; }
        .json-editor { height: 150px; width: 100%; font-family: monospace; }
        .response-area { min-height: 100px; }
        .api-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
        .api-title { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .sticky-top { top: 1rem; }
        .status-bar { font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">API Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Manager API</li>
            </ol>
        </nav>
        
        <div class="alert alert-info mb-3">
            <h5>Thông tin API Quản lý</h5>
            <p class="mb-0">API dành cho quản lý: lớp học, thời khóa biểu, và phân công giảng dạy.</p>
        </div>
        
        <!-- Status bar for authentication info -->
        <div class="card mb-4">
            <div class="card-body status-bar">
                <div class="row">
                    <div class="col-md-6" id="authStatus">
                        <span class="badge bg-warning">Chưa đăng nhập</span>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="checkAuthBtn" class="btn btn-sm btn-info">Kiểm tra xác thực</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Classes List API -->
        <div class="api-section" id="classes-section">
            <div class="api-title">
                <h3>Danh sách lớp học</h3>
                <span class="endpoint">GET /api/classes</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Lấy danh sách lớp học
                        </div>
                        <div class="card-body">
                            <form id="getClassesForm">
                                <div class="mb-3">
                                    <label for="grade" class="form-label">Khối (tùy chọn)</label>
                                    <select class="form-select" id="grade">
                                        <option value="">Tất cả</option>
                                        <option value="10">Khối 10</option>
                                        <option value="11">Khối 11</option>
                                        <option value="12">Khối 12</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Lấy danh sách lớp</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="classes-response-message">
                                <!-- Classes response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="classes-json" class="json-editor">{
  "grade": "10"
}</textarea>
                            <button id="classes-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="classes-response" class="response-area">// Kết quả API danh sách lớp học sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Class API -->
        <div class="api-section" id="create-class-section">
            <div class="api-title">
                <h3>Tạo lớp học mới</h3>
                <span class="endpoint">POST /api/classes</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            Tạo lớp học mới
                        </div>
                        <div class="card-body">
                            <form id="createClassForm">
                                <div class="mb-3">
                                    <label for="className" class="form-label">Tên lớp</label>
                                    <input type="text" class="form-control" id="className" required>
                                </div>
                                <div class="mb-3">
                                    <label for="classGrade" class="form-label">Khối</label>
                                    <select class="form-select" id="classGrade" required>
                                        <option value="10">Khối 10</option>
                                        <option value="11">Khối 11</option>
                                        <option value="12">Khối 12</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="homeTeacher" class="form-label">Giáo viên chủ nhiệm</label>
                                    <input type="text" class="form-control" id="homeTeacher" placeholder="ID giáo viên">
                                </div>
                                <button type="submit" class="btn btn-success">Tạo lớp học</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="create-class-response-message">
                                <!-- Create Class response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="create-class-json" class="json-editor">{
  "name": "10A1",
  "grade": "10",
  "homeTeacher": "teacher001"
}</textarea>
                            <button id="create-class-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="create-class-response" class="response-area">// Kết quả API tạo lớp học sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Class Schedule API -->
        <div class="api-section" id="class-schedule-section">
            <div class="api-title">
                <h3>Lấy thời khóa biểu lớp</h3>
                <span class="endpoint">GET /api/schedules/class/:id</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            Lấy thời khóa biểu lớp
                        </div>
                        <div class="card-body">
                            <form id="getClassScheduleForm">
                                <div class="mb-3">
                                    <label for="classId" class="form-label">ID lớp học</label>
                                    <input type="text" class="form-control" id="classId" required>
                                </div>
                                <button type="submit" class="btn btn-warning">Lấy thời khóa biểu</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="class-schedule-response-message">
                                <!-- Class Schedule response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            API Details
                        </div>
                        <div class="card-body">
                            <p>Gọi API với token hiện tại:</p>
                            <pre>GET /api/schedules/class/{classId}
Authorization: Bearer {token}</pre>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="class-schedule-response" class="response-area">// Kết quả API thời khóa biểu lớp sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Session API -->
        <div class="api-section" id="add-session-section">
            <div class="api-title">
                <h3>Thêm buổi học vào thời khóa biểu</h3>
                <span class="endpoint">POST /api/schedules/sessions</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Thêm buổi học vào thời khóa biểu
                        </div>
                        <div class="card-body">
                            <form id="addSessionForm">
                                <div class="mb-3">
                                    <label for="sessionClassId" class="form-label">ID lớp học</label>
                                    <input type="text" class="form-control" id="sessionClassId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="subjectId" class="form-label">ID môn học</label>
                                    <input type="text" class="form-control" id="subjectId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="teacherId" class="form-label">ID giáo viên</label>
                                    <input type="text" class="form-control" id="teacherId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="dayOfWeek" class="form-label">Thứ</label>
                                    <select class="form-select" id="dayOfWeek" required>
                                        <option value="2">Thứ 2</option>
                                        <option value="3">Thứ 3</option>
                                        <option value="4">Thứ 4</option>
                                        <option value="5">Thứ 5</option>
                                        <option value="6">Thứ 6</option>
                                        <option value="7">Thứ 7</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="period" class="form-label">Tiết học</label>
                                    <select class="form-select" id="period" required>
                                        <option value="1">Tiết 1</option>
                                        <option value="2">Tiết 2</option>
                                        <option value="3">Tiết 3</option>
                                        <option value="4">Tiết 4</option>
                                        <option value="5">Tiết 5</option>
                                        <option value="6">Tiết 6</option>
                                        <option value="7">Tiết 7</option>
                                        <option value="8">Tiết 8</option>
                                        <option value="9">Tiết 9</option>
                                        <option value="10">Tiết 10</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="roomId" class="form-label">ID phòng học</label>
                                    <input type="text" class="form-control" id="roomId">
                                </div>
                                <button type="submit" class="btn btn-info">Thêm buổi học</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="add-session-response-message">
                                <!-- Add Session response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="add-session-json" class="json-editor">{
  "classId": "class123",
  "subjectId": "subject123",
  "teacherId": "teacher123",
  "dayOfWeek": 2,
  "period": 1,
  "roomId": "room101"
}</textarea>
                            <button id="add-session-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="add-session-response" class="response-area">// Kết quả API thêm buổi học sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auth state management
        let token = localStorage.getItem('auth_token') || '';
        let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
        const baseUrl = window.location.origin;
        
        // Display formatted response message
        function displayResponseMessage(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            
            if (isSuccess) {
                element.innerHTML = `<div class="alert alert-success">${data}</div>`;
            } else {
                element.innerHTML = `<div class="alert alert-danger">${data}</div>`;
            }
        }
        
        // Display raw JSON response
        function displayRawResponse(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }
        
        // Log to console for debugging
        function logDebug(message, data) {
            console.log(`DEBUG - ${message}:`, data);
        }
        
        // Update authentication status display
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            
            if (token && currentUser) {
                authStatus.innerHTML = `
                    <span class="badge bg-success">Đã đăng nhập</span>
                    <span class="ms-2">Người dùng: <strong>${currentUser.name || currentUser.userId}</strong> (${currentUser.role})</span>
                `;
            } else {
                authStatus.innerHTML = `<span class="badge bg-warning">Chưa đăng nhập</span>`;
            }
        }
        
        // Initialize
        updateAuthStatus();
        
        // Sync form with JSON
        function syncFormToJson(formId, jsonId, getDataFn) {
            const form = document.getElementById(formId);
            form.addEventListener('input', () => {
                const jsonData = getDataFn();
                document.getElementById(jsonId).value = JSON.stringify(jsonData, null, 2);
            });
        }
        
        // Check Auth API functions
        async function executeCheckAuth() {
            try {
                if (!token) {
                    alert('Bạn chưa đăng nhập! Vui lòng đăng nhập ở trang Auth API trước.');
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Check auth response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('classes-response-message', 'Xác thực thành công!', true);
                } else {
                    displayResponseMessage('classes-response-message', data.message || 'Xác thực thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Check auth error', error);
                return { error: error.message };
            }
        }
        
        // Classes List API functions
        function getClassesData() {
            return {
                grade: document.getElementById('grade').value
            };
        }
        
        async function executeGetClasses(payload) {
            try {
                if (!token) {
                    displayResponseMessage('classes-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('classes-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                let url = `${baseUrl}/api/classes`;
                if (payload && payload.grade) {
                    url += `?grade=${payload.grade}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Classes response', data);
                
                // Display raw response
                displayRawResponse('classes-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('classes-response-message', 'Lấy danh sách lớp học thành công!', true);
                } else {
                    displayResponseMessage('classes-response-message', data.message || 'Lấy danh sách lớp học thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Classes error', error);
                displayRawResponse('classes-response', { error: error.message });
                displayResponseMessage('classes-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Create Class API functions
        function getCreateClassData() {
            return {
                name: document.getElementById('className').value,
                grade: document.getElementById('classGrade').value,
                homeTeacher: document.getElementById('homeTeacher').value || null
            };
        }
        
        async function executeCreateClass(payload) {
            try {
                if (!token) {
                    displayResponseMessage('create-class-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('create-class-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/classes`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: typeof payload === 'string' ? payload : JSON.stringify(payload)
                });
                
                const data = await response.json();
                logDebug('Create class response', data);
                
                // Display raw response
                displayRawResponse('create-class-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('create-class-response-message', 'Tạo lớp học thành công!', true);
                } else {
                    displayResponseMessage('create-class-response-message', data.message || 'Tạo lớp học thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Create class error', error);
                displayRawResponse('create-class-response', { error: error.message });
                displayResponseMessage('create-class-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Class Schedule API functions
        async function executeGetClassSchedule() {
            try {
                if (!token) {
                    displayResponseMessage('class-schedule-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('class-schedule-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const classId = document.getElementById('classId').value;
                
                if (!classId) {
                    displayResponseMessage('class-schedule-response-message', 'Vui lòng nhập ID lớp học!', false);
                    displayRawResponse('class-schedule-response', { error: 'Thiếu ID lớp học' });
                    return { error: 'Thiếu ID lớp học' };
                }
                
                const response = await fetch(`${baseUrl}/api/schedules/class/${classId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Class schedule response', data);
                
                // Display raw response
                displayRawResponse('class-schedule-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('class-schedule-response-message', 'Lấy thời khóa biểu lớp thành công!', true);
                } else {
                    displayResponseMessage('class-schedule-response-message', data.message || 'Lấy thời khóa biểu lớp thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Class schedule error', error);
                displayRawResponse('class-schedule-response', { error: error.message });
                displayResponseMessage('class-schedule-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Add Session API functions
        function getAddSessionData() {
            return {
                classId: document.getElementById('sessionClassId').value,
                subjectId: document.getElementById('subjectId').value,
                teacherId: document.getElementById('teacherId').value,
                dayOfWeek: parseInt(document.getElementById('dayOfWeek').value),
                period: parseInt(document.getElementById('period').value),
                roomId: document.getElementById('roomId').value || null
            };
        }
        
        async function executeAddSession(payload) {
            try {
                if (!token) {
                    displayResponseMessage('add-session-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('add-session-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/schedules/sessions`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: typeof payload === 'string' ? payload : JSON.stringify(payload)
                });
                
                const data = await response.json();
                logDebug('Add session response', data);
                
                // Display raw response
                displayRawResponse('add-session-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('add-session-response-message', 'Thêm buổi học thành công!', true);
                } else {
                    displayResponseMessage('add-session-response-message', data.message || 'Thêm buổi học thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Add session error', error);
                displayRawResponse('add-session-response', { error: error.message });
                displayResponseMessage('add-session-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Setup event listeners
        
        // Check Auth button
        document.getElementById('checkAuthBtn').addEventListener('click', async () => {
            await executeCheckAuth();
        });
        
        // Classes List
        document.getElementById('getClassesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeGetClasses(getClassesData());
        });
        
        document.getElementById('classes-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('classes-json').value);
                await executeGetClasses(jsonData);
            } catch (error) {
                displayResponseMessage('classes-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('classes-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Create Class
        document.getElementById('createClassForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeCreateClass(getCreateClassData());
        });
        
        document.getElementById('create-class-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('create-class-json').value);
                await executeCreateClass(jsonData);
            } catch (error) {
                displayResponseMessage('create-class-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('create-class-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Class Schedule
        document.getElementById('getClassScheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeGetClassSchedule();
        });
        
        // Add Session
        document.getElementById('addSessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeAddSession(getAddSessionData());
        });
        
        document.getElementById('add-session-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('add-session-json').value);
                await executeAddSession(jsonData);
            } catch (error) {
                displayResponseMessage('add-session-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('add-session-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Sync forms to JSON
        syncFormToJson('getClassesForm', 'classes-json', getClassesData);
        syncFormToJson('createClassForm', 'create-class-json', getCreateClassData);
        syncFormToJson('addSessionForm', 'add-session-json', getAddSessionData);
    </script>
</body>
</html> 