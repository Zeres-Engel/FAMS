<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .endpoint { font-family: monospace; color: #0d6efd; }
        .json-editor { height: 150px; width: 100%; font-family: monospace; }
        .response-area { min-height: 100px; }
        .api-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
        .api-title { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .sticky-top { top: 1rem; }
        .status-bar { font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">API Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Authentication API</li>
            </ol>
        </nav>
        
        <div class="alert alert-info mb-3">
            <h5>Thông tin API xác thực</h5>
            <p class="mb-0">Sử dụng <code>userId</code> để đăng nhập. Tài khoản demo: <code>admin</code> / <code>1234</code></p>
        </div>
        
        <!-- Status bar for authentication info -->
        <div class="card mb-4">
            <div class="card-body status-bar">
                <div class="row">
                    <div class="col-md-6" id="authStatus">
                        <span class="badge bg-warning">Chưa đăng nhập</span>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="logoutBtn" class="btn btn-sm btn-danger" disabled>Đăng xuất</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Login API -->
        <div class="api-section" id="login-section">
            <div class="api-title">
                <h3>Đăng nhập</h3>
                <span class="endpoint">POST /api/auth/login</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Form đăng nhập
                        </div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="userId" class="form-label">Tên đăng nhập (userId)</label>
                                    <input type="text" class="form-control" id="userId" value="admin">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Mật khẩu</label>
                                    <input type="password" class="form-control" id="password" value="1234">
                                </div>
                                <button type="submit" class="btn btn-primary">Đăng nhập</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="login-response-message">
                                <!-- Login response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="login-json" class="json-editor">{
  "userId": "admin",
  "password": "1234"
}</textarea>
                            <button id="login-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="login-response" class="response-area">// Kết quả API đăng nhập sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Register API -->
        <div class="api-section" id="register-section">
            <div class="api-title">
                <h3>Đăng ký</h3>
                <span class="endpoint">POST /api/auth/register</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            Form đăng ký
                        </div>
                        <div class="card-body">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label for="regUserId" class="form-label">Tên đăng nhập (userId)</label>
                                    <input type="text" class="form-control" id="regUserId" placeholder="vd: student001">
                                </div>
                                <div class="mb-3">
                                    <label for="regName" class="form-label">Họ tên</label>
                                    <input type="text" class="form-control" id="regName">
                                </div>
                                <div class="mb-3">
                                    <label for="regEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="regEmail">
                                </div>
                                <div class="mb-3">
                                    <label for="regPassword" class="form-label">Mật khẩu</label>
                                    <input type="password" class="form-control" id="regPassword">
                                </div>
                                <div class="mb-3">
                                    <label for="role" class="form-label">Vai trò</label>
                                    <select class="form-select" id="role">
                                        <option value="Student">Học sinh</option>
                                        <option value="Teacher">Giáo viên</option>
                                        <option value="Parent">Phụ huynh</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success">Đăng ký</button>
                            </form>
                            
                            <div class="mt-3 response-area" id="register-response-message">
                                <!-- Register response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="register-json" class="json-editor">{
  "userId": "newuser001",
  "name": "Người dùng mới",
  "email": "newuser@example.com",
  "password": "password123",
  "role": "Student"
}</textarea>
                            <button id="register-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="register-response" class="response-area">// Kết quả API đăng ký sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Check Auth API -->
        <div class="api-section" id="check-auth-section">
            <div class="api-title">
                <h3>Kiểm tra xác thực</h3>
                <span class="endpoint">GET /api/auth/me</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Kiểm tra thông tin tài khoản
                        </div>
                        <div class="card-body">
                            <p>Kiểm tra thông tin tài khoản đã đăng nhập hiện tại.</p>
                            <button id="checkAuthBtn" class="btn btn-info">Kiểm tra xác thực</button>
                            
                            <div class="mt-3 response-area" id="check-auth-response-message">
                                <!-- Check Auth response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            API Details
                        </div>
                        <div class="card-body">
                            <p>Gọi API với token hiện tại:</p>
                            <pre>GET /api/auth/me
Authorization: Bearer {token}</pre>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="check-auth-response" class="response-area">// Kết quả API kiểm tra xác thực sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Refresh Token API -->
        <div class="api-section" id="refresh-token-section">
            <div class="api-title">
                <h3>Làm mới Token</h3>
                <span class="endpoint">POST /api/auth/refresh-token</span>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            Làm mới token
                        </div>
                        <div class="card-body">
                            <p>Làm mới token xác thực khi token cũ sắp hết hạn.</p>
                            <button id="refreshTokenBtn" class="btn btn-warning">Làm mới token</button>
                            
                            <div class="mt-3 response-area" id="refresh-token-response-message">
                                <!-- Refresh token response message will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            Raw JSON Request
                        </div>
                        <div class="card-body">
                            <textarea id="refresh-token-json" class="json-editor">{
  "refreshToken": "your_refresh_token_here"
}</textarea>
                            <button id="refresh-token-execute" class="btn btn-secondary mt-2">Execute</button>
                            
                            <div class="mt-3">
                                <h6 class="text-muted">Response:</h6>
                                <pre id="refresh-token-response" class="response-area">// Kết quả API làm mới token sẽ hiển thị ở đây</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auth state management
        let token = localStorage.getItem('auth_token') || '';
        let refreshToken = localStorage.getItem('refresh_token') || '';
        let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
        const baseUrl = window.location.origin;
        
        // Display formatted response message
        function displayResponseMessage(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            
            if (isSuccess) {
                element.innerHTML = `<div class="alert alert-success">${data}</div>`;
            } else {
                element.innerHTML = `<div class="alert alert-danger">${data}</div>`;
            }
        }
        
        // Display raw JSON response
        function displayRawResponse(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }
        
        // Log to console for debugging
        function logDebug(message, data) {
            console.log(`DEBUG - ${message}:`, data);
        }
        
        // Update authentication status display
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (token && currentUser) {
                authStatus.innerHTML = `
                    <span class="badge bg-success">Đã đăng nhập</span>
                    <span class="ms-2">Người dùng: <strong>${currentUser.name || currentUser.userId}</strong> (${currentUser.role})</span>
                `;
                logoutBtn.disabled = false;
                
                // Update refresh token JSON
                document.getElementById('refresh-token-json').value = JSON.stringify({
                    refreshToken: refreshToken || "your_refresh_token_here"
                }, null, 2);
            } else {
                authStatus.innerHTML = `<span class="badge bg-warning">Chưa đăng nhập</span>`;
                logoutBtn.disabled = true;
            }
        }
        
        // Initialize
        updateAuthStatus();
        
        // Sync form with JSON
        function syncFormToJson(formId, jsonId, getDataFn) {
            const form = document.getElementById(formId);
            form.addEventListener('input', () => {
                const jsonData = getDataFn();
                document.getElementById(jsonId).value = JSON.stringify(jsonData, null, 2);
            });
        }
        
        // Login API functions
        function getLoginFormData() {
            return {
                userId: document.getElementById('userId').value,
                password: document.getElementById('password').value
            };
        }
        
        async function executeLogin(payload) {
            try {
                logDebug('Login payload', payload);
                
                const response = await fetch(`${baseUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: typeof payload === 'string' ? payload : JSON.stringify(payload)
                });
                
                logDebug('Login status', response.status);
                
                const data = await response.json();
                logDebug('Login response', data);
                
                // Display raw response
                displayRawResponse('login-response', data);
                
                // Handle successful login
                if (data.success && data.data) {
                    const userData = data.data;
                    token = userData.token;
                    refreshToken = userData.refreshToken || '';
                    currentUser = {
                        userId: userData.userId,
                        name: userData.name,
                        email: userData.email,
                        role: userData.role
                    };
                    
                    localStorage.setItem('auth_token', token);
                    if (refreshToken) localStorage.setItem('refresh_token', refreshToken);
                    if (currentUser) localStorage.setItem('current_user', JSON.stringify(currentUser));
                    
                    updateAuthStatus();
                    displayResponseMessage('login-response-message', 'Đăng nhập thành công!', true);
                } else {
                    displayResponseMessage('login-response-message', data.message || 'Đăng nhập thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Login error', error);
                displayRawResponse('login-response', { error: error.message });
                displayResponseMessage('login-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Register API functions
        function getRegisterFormData() {
            return {
                userId: document.getElementById('regUserId').value,
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                role: document.getElementById('role').value
            };
        }
        
        async function executeRegister(payload) {
            try {
                const response = await fetch(`${baseUrl}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: typeof payload === 'string' ? payload : JSON.stringify(payload)
                });
                
                const data = await response.json();
                logDebug('Register response', data);
                
                // Display raw response
                displayRawResponse('register-response', data);
                
                // Handle successful registration
                if (data.success && data.data) {
                    const userData = data.data;
                    token = userData.accessToken;
                    refreshToken = userData.refreshToken || '';
                    currentUser = {
                        userId: userData.userId,
                        name: userData.name,
                        email: userData.email,
                        role: userData.role
                    };
                    
                    localStorage.setItem('auth_token', token);
                    if (refreshToken) localStorage.setItem('refresh_token', refreshToken);
                    if (currentUser) localStorage.setItem('current_user', JSON.stringify(currentUser));
                    
                    updateAuthStatus();
                    displayResponseMessage('register-response-message', 'Đăng ký thành công!', true);
                } else {
                    displayResponseMessage('register-response-message', data.message || 'Đăng ký thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Register error', error);
                displayRawResponse('register-response', { error: error.message });
                displayResponseMessage('register-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Check Auth API functions
        async function executeCheckAuth() {
            try {
                if (!token) {
                    displayResponseMessage('check-auth-response-message', 'Bạn chưa đăng nhập!', false);
                    displayRawResponse('check-auth-response', { error: 'Không có token xác thực' });
                    return { error: 'Không có token xác thực' };
                }
                
                const response = await fetch(`${baseUrl}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                logDebug('Check auth response', data);
                
                // Display raw response
                displayRawResponse('check-auth-response', data);
                
                if (data.success && data.data) {
                    displayResponseMessage('check-auth-response-message', 'Xác thực thành công!', true);
                } else {
                    displayResponseMessage('check-auth-response-message', data.message || 'Xác thực thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Check auth error', error);
                displayRawResponse('check-auth-response', { error: error.message });
                displayResponseMessage('check-auth-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Refresh Token API functions
        async function executeRefreshToken(payload) {
            try {
                if (!refreshToken && !payload.refreshToken) {
                    displayResponseMessage('refresh-token-response-message', 'Không có refresh token!', false);
                    displayRawResponse('refresh-token-response', { error: 'Không có refresh token' });
                    return { error: 'Không có refresh token' };
                }
                
                const tokenToUse = payload.refreshToken || refreshToken;
                
                const response = await fetch(`${baseUrl}/api/auth/refresh-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken: tokenToUse })
                });
                
                const data = await response.json();
                logDebug('Refresh token response', data);
                
                // Display raw response
                displayRawResponse('refresh-token-response', data);
                
                if (data.success && data.data) {
                    token = data.data.accessToken;
                    refreshToken = data.data.refreshToken;
                    localStorage.setItem('auth_token', token);
                    localStorage.setItem('refresh_token', refreshToken);
                    
                    updateAuthStatus();
                    displayResponseMessage('refresh-token-response-message', 'Token đã được làm mới!', true);
                } else {
                    displayResponseMessage('refresh-token-response-message', data.message || 'Làm mới token thất bại!', false);
                }
                
                return data;
            } catch (error) {
                logDebug('Refresh token error', error);
                displayRawResponse('refresh-token-response', { error: error.message });
                displayResponseMessage('refresh-token-response-message', 'Lỗi: ' + error.message, false);
                return { error: error.message };
            }
        }
        
        // Logout function
        async function executeLogout() {
            try {
                const response = await fetch(`${baseUrl}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                // Clear token
                token = '';
                refreshToken = '';
                currentUser = null;
                localStorage.removeItem('auth_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('current_user');
                
                updateAuthStatus();
                
                // Show alert
                alert('Đã đăng xuất thành công!');
                
                return data;
            } catch (error) {
                console.error('Logout error:', error);
                alert('Lỗi khi đăng xuất: ' + error.message);
                return { error: error.message };
            }
        }
        
        // Setup event listeners
        
        // Login form and execute button
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeLogin(getLoginFormData());
        });
        
        document.getElementById('login-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('login-json').value);
                await executeLogin(jsonData);
            } catch (error) {
                displayResponseMessage('login-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('login-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Register form and execute button
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeRegister(getRegisterFormData());
        });
        
        document.getElementById('register-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('register-json').value);
                await executeRegister(jsonData);
            } catch (error) {
                displayResponseMessage('register-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('register-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Check Auth button
        document.getElementById('checkAuthBtn').addEventListener('click', async () => {
            await executeCheckAuth();
        });
        
        // Refresh Token button and execute button
        document.getElementById('refreshTokenBtn').addEventListener('click', async () => {
            await executeRefreshToken({ refreshToken });
        });
        
        document.getElementById('refresh-token-execute').addEventListener('click', async () => {
            try {
                const jsonData = JSON.parse(document.getElementById('refresh-token-json').value);
                await executeRefreshToken(jsonData);
            } catch (error) {
                displayResponseMessage('refresh-token-response-message', 'JSON không hợp lệ: ' + error.message, false);
                displayRawResponse('refresh-token-response', { error: 'JSON không hợp lệ: ' + error.message });
            }
        });
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await executeLogout();
        });
        
        // Sync forms to JSON
        syncFormToJson('loginForm', 'login-json', getLoginFormData);
        syncFormToJson('registerForm', 'register-json', getRegisterFormData);
    </script>
</body>
</html> 