<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMS API Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .auth-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        pre {
            white-space: pre-wrap;
            word-break: break-all;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .profile-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .profile-card {
            flex: 1;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .schedule-container {
            margin-top: 20px;
        }
        .schedule-day {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .schedule-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #e8f4fd;
            border-radius: 4px;
        }
        .user-schedule-info {
            background-color: #f1f8e9;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #8bc34a;
        }
        .semester-info {
            background-color: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }
        .current-info {
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            padding: 15px 0;
        }
        .schedule-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .schedule-table th {
            background-color: #f2f2f2;
        }
        .schedule-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .schedule-filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }
        .small-button {
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 5px;
            vertical-align: middle;
        }
        .debug-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .debug-panel pre {
            max-height: 400px;
            overflow-y: auto;
            background-color: #282c34;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
        }
        .debug-panel .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .action-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FAMS API Test</h1>
        
        <div class="auth-section">
            <h2>Đăng nhập</h2>
            <div class="form-group">
                <label for="login-type">Đăng nhập bằng:</label>
                <select id="login-type" name="login-type">
                    <option value="userId">User ID</option>
                    <option value="email">Email</option>
                </select>
            </div>
            <div class="form-group" id="userId-group">
                <label for="userId">User ID:</label>
                <input type="text" id="userId" name="userId" placeholder="Nhập user ID">
            </div>
            <div class="form-group hidden" id="email-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Nhập email">
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" name="password" placeholder="Nhập mật khẩu">
            </div>
            <button id="login-btn">Đăng nhập</button>
            <div id="login-result" class="result hidden"></div>
            <div id="login-error" class="error hidden"></div>
        </div>
        
        <div id="user-info" class="hidden">
            <h2>Thông tin người dùng</h2>
            <div class="profile-info">
                <div class="profile-card">
                    <h3>Thông tin cá nhân</h3>
                    <div id="profile-data"></div>
                </div>
                <div class="profile-card">
                    <h3>Vai trò</h3>
                    <div id="role-data"></div>
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="schedule">Lịch học</button>
                    <button class="tab-button" data-tab="advanced-schedule">Lịch học nâng cao</button>
                    <button class="tab-button" data-tab="raw">Dữ liệu gốc</button>
                    <button class="tab-button" data-tab="debug">Debug Info</button>
                </div>
                <div class="tab-content">
                    <div id="schedule-tab" class="tab-pane active">
                        <h2>Lịch học</h2>
                        <div class="schedule-filter-bar">
                            <div class="filter-item">
                                <label for="schedule-search">Tìm kiếm:</label>
                                <input type="text" id="schedule-search" placeholder="Nhập từ khóa...">
                            </div>
                            <div class="filter-item">
                                <label for="schedule-filter-date">Lọc theo ngày:</label>
                                <input type="date" id="schedule-filter-date">
                            </div>
                            <button id="filter-schedule-btn">Lọc</button>
                            <button id="reset-filter-btn">Đặt lại</button>
                        </div>
                        <div id="schedule-container" class="schedule-container"></div>
                    </div>
                    <div id="advanced-schedule-tab" class="tab-pane hidden">
                        <h2>Lịch học nâng cao</h2>
                        <div class="schedule-filters">
                            <div class="filter-item">
                                <label for="schedule-type">Loại lịch:</label>
                                <select id="schedule-type">
                                    <option value="daily">Lịch theo ngày</option>
                                    <option value="weekly">Lịch theo tuần</option>
                                    <option value="semester">Lịch theo học kỳ</option>
                                </select>
                            </div>
                            <div class="filter-item" id="date-filter">
                                <label for="schedule-date">Ngày:</label>
                                <input type="date" id="schedule-date">
                                <button id="debug-daily-schedule" class="small-button">Debug API</button>
                            </div>
                            <div class="filter-item" id="year-filter" class="hidden">
                                <label for="schedule-year">Năm học:</label>
                                <select id="schedule-year">
                                    <option value="2023">2023 - 2024</option>
                                    <option value="2024" selected>2024 - 2025</option>
                                    <option value="2025">2025 - 2026</option>
                                </select>
                            </div>
                            <div class="filter-item" id="week-filter" class="hidden">
                                <label for="schedule-week-dropdown">Tuần:</label>
                                <select id="schedule-week-dropdown">
                                    <option value="">Đang tải...</option>
                                </select>
                                <button id="debug-weekly-api" class="small-button">Debug Tuần</button>
                            </div>
                            <div class="filter-item" id="semester-filter" class="hidden">
                                <label for="schedule-semester">Học kỳ:</label>
                                <select id="schedule-semester">
                                    <option value="">Đang tải...</option>
                                </select>
                            </div>
                            <div class="filter-item" id="student-filter" class="hidden">
                                <label for="student-id">Học sinh:</label>
                                <select id="student-id">
                                    <option value="">Đang tải...</option>
                                </select>
                            </div>
                            <div class="filter-item hidden" id="week-range-filter">
                                <label for="schedule-week-range">Khoảng tuần:</label>
                                <input type="text" id="schedule-week-range" placeholder="YYYY-MM-DD to YYYY-MM-DD">
                                <button id="get-current-week-btn" class="small-button">Tuần hiện tại</button>
                            </div>
                        </div>
                        <button id="fetch-schedule-btn">Lấy lịch học</button>
                        <div id="advanced-schedule-container">
                            <div class="result hidden" id="advanced-schedule-result"></div>
                            <table class="schedule-table hidden" id="schedule-table">
                                <thead>
                                    <tr>
                                        <th>Tiết</th>
                                        <th>Môn học</th>
                                        <th>Giáo viên</th>
                                        <th>Phòng</th>
                                        <th>Ngày</th>
                                        <th>Chủ đề</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="raw-tab" class="tab-pane hidden">
                        <h2>Dữ liệu gốc</h2>
                        <pre id="raw-data"></pre>
                    </div>
                    <div id="debug-tab" class="tab-pane hidden">
                        <h2>Debug Information</h2>
                        <div class="debug-panel">
                            <h3>Last API Response</h3>
                            <pre id="debug-response"></pre>
                            
                            <h3>API Call Information</h3>
                            <div id="debug-call-info"></div>
                            
                            <button id="test-daily-api" class="action-button">Test Daily Schedule API</button>
                            <button id="test-weekly-api" class="action-button">Test Weekly Schedule API</button>
                            <button id="check-sessionweek-field" class="action-button">Check SessionWeek Field</button>
                            
                            <h3>Weekly Schedule Debugging</h3>
                            <div class="form-group">
                                <label for="debug-week-range">Weekly Range to Test:</label>
                                <input type="text" id="debug-week-range" placeholder="YYYY-MM-DD to YYYY-MM-DD" style="width: 300px;">
                                <button id="get-current-week-debug" class="small-button">Current Week</button>
                            </div>
                            <div class="form-group">
                                <button id="test-week-range-api" class="action-button">Test Week Range API</button>
                                <button id="fix-session-week" class="action-button">Fix SessionWeek Field</button>
                            </div>
                            <div id="debug-weekly-result" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cấu hình API
        const API_BASE_URL = window.location.origin;
        let authToken = '';
        let userData = null;
        
        // Các phần tử DOM
        const loginTypeSelect = document.getElementById('login-type');
        const userIdGroup = document.getElementById('userId-group');
        const emailGroup = document.getElementById('email-group');
        const userIdInput = document.getElementById('userId');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginResult = document.getElementById('login-result');
        const loginError = document.getElementById('login-error');
        const userInfo = document.getElementById('user-info');
        const profileData = document.getElementById('profile-data');
        const roleData = document.getElementById('role-data');
        const scheduleContainer = document.getElementById('schedule-container');
        const rawData = document.getElementById('raw-data');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // Advanced schedule elements
        const scheduleTypeSelect = document.getElementById('schedule-type');
        const dateFilter = document.getElementById('date-filter');
        const weekFilter = document.getElementById('week-filter');
        const yearFilter = document.getElementById('year-filter');
        const semesterFilter = document.getElementById('semester-filter');
        const studentFilter = document.getElementById('student-id');
        const scheduleDateInput = document.getElementById('schedule-date');
        const scheduleWeekInput = document.getElementById('schedule-week-dropdown');
        const semesterSelect = document.getElementById('schedule-semester');
        const studentSelect = document.getElementById('student-id');
        const fetchScheduleBtn = document.getElementById('fetch-schedule-btn');
        const advancedScheduleResult = document.getElementById('advanced-schedule-result');
        const scheduleTable = document.getElementById('schedule-table');
        const scheduleTableBody = document.getElementById('schedule-table-body');
        
        // Filter và search cho lịch học
        const scheduleSearch = document.getElementById('schedule-search');
        const scheduleFilterDate = document.getElementById('schedule-filter-date');
        const filterScheduleBtn = document.getElementById('filter-schedule-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        
        let originalScheduleData = null;
        
        // Xử lý thay đổi loại đăng nhập
        loginTypeSelect.addEventListener('change', function() {
            if (this.value === 'userId') {
                userIdGroup.classList.remove('hidden');
                emailGroup.classList.add('hidden');
            } else {
                userIdGroup.classList.add('hidden');
                emailGroup.classList.remove('hidden');
            }
        });
        
        // Xử lý thay đổi loại lịch học
        scheduleTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            // Ẩn tất cả các bộ lọc
            dateFilter.classList.add('hidden');
            weekFilter.classList.add('hidden');
            yearFilter.classList.add('hidden');
            semesterFilter.classList.add('hidden');
            studentFilter.classList.add('hidden');
            weekRangeFilter.classList.add('hidden');
            
            // Hiển thị bộ lọc phù hợp
            if (selectedType === 'daily') {
                dateFilter.classList.remove('hidden');
            } else if (selectedType === 'weekly') {
                weekFilter.classList.remove('hidden');
                yearFilter.classList.remove('hidden');
            } else if (selectedType === 'semester') {
                semesterFilter.classList.remove('hidden');
                yearFilter.classList.remove('hidden');
            }
            
            // Hiển thị bộ lọc học sinh nếu là phụ huynh
            if (userData && userData.role === 'Parent') {
                studentFilter.classList.remove('hidden');
            }
        });
        
        // Xử lý đăng nhập
        loginBtn.addEventListener('click', async function() {
            // Reset các thông báo
            loginResult.classList.add('hidden');
            loginError.classList.add('hidden');
            
            try {
                const loginType = loginTypeSelect.value;
                const password = passwordInput.value;
                let loginData = {};
                
                if (loginType === 'userId') {
                    const userId = userIdInput.value;
                    if (!userId) {
                        throw new Error('Vui lòng nhập User ID');
                    }
                    loginData = { userId, password };
                } else {
                    const email = emailInput.value;
                    if (!email) {
                        throw new Error('Vui lòng nhập Email');
                    }
                    loginData = { email, password };
                }
                
                if (!password) {
                    throw new Error('Vui lòng nhập mật khẩu');
                }
                
                // Gọi API đăng nhập
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Đăng nhập thất bại');
                }
                
                // Lưu token và thông tin người dùng
                authToken = result.data.token;
                userData = result.data;
                
                // Hiển thị kết quả đăng nhập
                loginResult.innerHTML = `<p>Đăng nhập thành công! Xin chào ${result.data.name}</p>`;
                loginResult.classList.remove('hidden');
                
                // Hiển thị thông tin người dùng
                displayUserInfo(userData);
                
                // Lấy lịch học của người dùng
                await fetchUserSchedule();
                
                // Nếu đăng nhập thành công, tải danh sách học kỳ
                await fetchSemesters();
                
                // Hiển thị thông tin học kỳ và tuần hiện tại
                await loadCurrentScheduleAndSemester();
                
                // Nếu là phụ huynh, tải danh sách học sinh
                if (userData.role === 'Parent') {
                    loadStudentList(userData);
                }
                
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            }
        });
        
        // Hiển thị thông tin người dùng
        function displayUserInfo(user) {
            // Hiển thị phần thông tin người dùng
            userInfo.classList.remove('hidden');
            
            // Hiển thị thông tin cá nhân
            let profileHtml = `
                <p><strong>Tên:</strong> ${user.name}</p>
                <p><strong>User ID:</strong> ${user.userId}</p>
                <p><strong>Email:</strong> ${user.email}</p>
            `;
            
            // Thêm thông tin bổ sung dựa trên vai trò
            if (user.role === 'Student' && user.studentId) {
                profileHtml += `<p><strong>Mã học sinh:</strong> ${user.studentId}</p>`;
                profileHtml += `<p><strong>Lớp:</strong> ${user.classId || 'Chưa phân lớp'}</p>`;
            } else if (user.role === 'Teacher' && user.teacherId) {
                profileHtml += `<p><strong>Mã giáo viên:</strong> ${user.teacherId}</p>`;
            } else if (user.role === 'Parent' && user.parentId) {
                profileHtml += `<p><strong>Mã phụ huynh:</strong> ${user.parentId}</p>`;
            }
            
            profileData.innerHTML = profileHtml;
            
            // Hiển thị vai trò
            roleData.innerHTML = `
                <p><strong>Vai trò:</strong> ${translateRole(user.role)}</p>
                <p><strong>Mô tả:</strong> ${getRoleDescription(user.role)}</p>
            `;
            
            // Hiển thị dữ liệu gốc
            rawData.textContent = JSON.stringify(user, null, 2);
        }
        
        // Lấy lịch học của người dùng
        async function fetchUserSchedule() {
            try {
                scheduleContainer.innerHTML = '<p>Đang tải lịch học...</p>';
                
                const response = await fetch(`${API_BASE_URL}/api/schedules/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Không thể lấy lịch học');
                }
                
                console.log('Schedule API Response:', result);
                
                // Cập nhật dữ liệu gốc
                rawData.textContent = JSON.stringify(result, null, 2);
                
                // Lưu dữ liệu gốc để phục vụ tìm kiếm/lọc
                originalScheduleData = result.data;
                
                // Hiển thị lịch học
                displaySchedule(result.data);
                
                // Tự động hiển thị tab lịch học
                document.querySelector('.tab-button[data-tab="schedule"]').click();
                
                return result;
            } catch (error) {
                console.error('Error fetching schedule:', error);
                scheduleContainer.innerHTML = `<div class="error">${error.message}</div>`;
                return null;
            }
        }
        
        // Chức năng debug để kiểm tra thông tin học kỳ
        async function debugCheckSemesters() {
            try {
                // Hiển thị thông tin debug trong console
                console.log('DEBUG: Kiểm tra thông tin học kỳ');
                
                // Thử truy vấn trực tiếp collection Semester
                const response = await fetch(`${API_BASE_URL}/api/database/collections/Semester`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                console.log('DEBUG: Thông tin học kỳ từ collection Semester:', result);
                
                // Thử truy vấn trực tiếp collection semesters
                const response2 = await fetch(`${API_BASE_URL}/api/database/collections/semesters`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result2 = await response2.json();
                console.log('DEBUG: Thông tin học kỳ từ collection semesters:', result2);
                
                return { Semester: result, semesters: result2 };
            } catch (error) {
                console.error('DEBUG ERROR:', error);
                return null;
            }
        }
        
        // Xử lý nút lấy lịch học nâng cao
        fetchScheduleBtn.addEventListener('click', async function() {
            try {
                advancedScheduleResult.classList.add('hidden');
                scheduleTable.classList.add('hidden');
                advancedScheduleResult.innerHTML = 'Đang tải lịch học...';
                advancedScheduleResult.classList.remove('hidden');
                
                const scheduleType = scheduleTypeSelect.value;
                let endpoint = '';
                let params = new URLSearchParams();
                
                switch(scheduleType) {
                    case 'daily':
                        const date = scheduleDateInput.value;
                        if (!date) {
                            throw new Error('Vui lòng chọn ngày');
                        }
                        endpoint = `/api/schedules/daily/${date}`;
                        break;
                    case 'weekly':
                        // Lấy thông tin tuần từ dropdown
                        const weekDropdown = document.getElementById('schedule-week-dropdown');
                        const selectedOption = weekDropdown.options[weekDropdown.selectedIndex];
                        
                        if (!selectedOption || !selectedOption.value) {
                            throw new Error('Vui lòng chọn tuần');
                        }
                        
                        // Tạo chuỗi SessionWeek theo đúng format "YYYY-MM-DD to YYYY-MM-DD"
                        if (selectedOption.dataset.start && selectedOption.dataset.end) {
                            // Sử dụng trực tiếp endpoint week-range với SessionWeek string
                            const sessionWeek = `${selectedOption.dataset.start} to ${selectedOption.dataset.end}`;
                            console.log('SessionWeek tìm kiếm:', sessionWeek);
                            
                            // Log session week for debugging
                            advancedScheduleResult.innerHTML += `<p class="current-info">Tìm kiếm lịch học cho tuần: ${sessionWeek}</p>`;
                            
                            // Sử dụng endpoint week-range thay vì weekly
                            endpoint = `/api/schedules/week-range/${encodeURIComponent(sessionWeek)}`;
                        } else {
                            // Fallback to standard weekly if needed
                            endpoint = '/api/schedules/weekly';
                            params.append('week', selectedOption.value);
                            
                            // Thêm semester nếu có
                            const semesterId = semesterSelect.value;
                            if (semesterId) params.append('semesterId', semesterId);
                        }
                        break;
                    case 'semester':
                        const semester = semesterSelect.value;
                        if (!semester) {
                            throw new Error('Vui lòng chọn học kỳ');
                        }
                        endpoint = `/api/schedules/semester/${semester}`;
                        break;
                    case 'week-range':
                        const weekRange = scheduleWeekRangeInput.value;
                        if (!weekRange) {
                            throw new Error('Vui lòng nhập khoảng tuần');
                        }
                        advancedScheduleResult.innerHTML += `<p class="current-info">Tìm kiếm lịch học cho tuần: ${weekRange}</p>`;
                        endpoint = `/api/schedules/week-range/${encodeURIComponent(weekRange)}`;
                        break;
                }
                
                // Thêm studentId cho phụ huynh
                if (userData && userData.role === 'Parent' && studentSelect.value) {
                    params.append('studentId', studentSelect.value);
                }
                
                // Thêm params vào URL
                const queryString = params.toString();
                if (queryString) {
                    endpoint += `?${queryString}`;
                }
                
                console.log('Gọi API endpoint:', endpoint);
                advancedScheduleResult.innerHTML += `<p class="current-info">Gọi API: ${endpoint}</p>`;
                
                // Thêm timestamp vào request cho debugging
                const debugTimestamp = new Date().toISOString();
                const headers = {
                    'Authorization': `Bearer ${authToken}`,
                    'X-Debug-Timestamp': debugTimestamp
                };
                
                // Log to console for debugging
                console.log(`API Call [${debugTimestamp}]:`, {
                    endpoint,
                    headers: {...headers}
                });
                
                const startTime = performance.now();
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers
                });
                const endTime = performance.now();
                
                // Log response status and timing
                const timeTaken = (endTime - startTime).toFixed(2);
                console.log(`API Response [${debugTimestamp}]:`, {
                    status: response.status,
                    statusText: response.statusText,
                    timeTaken: `${timeTaken}ms`
                });
                
                advancedScheduleResult.innerHTML += `<p class="current-info">API trả về mã: ${response.status} ${response.statusText} (${timeTaken}ms)</p>`;
                
                const result = await response.json();
                
                // Cập nhật dữ liệu gốc để debugging
                rawData.textContent = JSON.stringify(result, null, 2);
                
                console.log(`API Data [${debugTimestamp}]:`, result);
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Không thể lấy lịch học');
                }
                
                // Hiển thị kết quả theo dạng bảng
                displayScheduleTable(result.data);
                
            } catch (error) {
                console.error('Error fetching advanced schedule:', error);
                advancedScheduleResult.innerHTML += `<div class="error">${error.message}</div>`;
                advancedScheduleResult.classList.remove('hidden');
                
                // Show debugging info in the raw tab
                document.querySelector('.tab-button[data-tab="raw"]').click();
            }
        });
        
        // Cập nhật fetchSemesters để xử lý trường hợp semesters không tồn tại
        async function fetchSemesters() {
            try {
                console.log("Đang nạp thông tin học kỳ...");
                
                // Sử dụng /me endpoint để lấy thông tin lịch học và trích xuất semester từ đó
                const response = await fetch(`${API_BASE_URL}/api/schedules/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    console.warn('Không thể lấy lịch học từ /me endpoint, thử phương pháp khác');
                    await extractSemestersFromSchedule();
                    return;
                }
                
                // Kiểm tra xem có semester trong data không
                if (result.data && result.data.schedules) {
                    console.log("Trích xuất semesters từ dữ liệu lịch học");
                    
                    // Trích xuất danh sách học kỳ từ dữ liệu lịch học
                    const semesterMap = new Map();
                    
                    result.data.schedules.forEach(schedule => {
                        if (schedule.semesterId) {
                            // Nếu chưa có thông tin học kỳ này, thêm vào Map
                            if (!semesterMap.has(schedule.semesterId)) {
                                semesterMap.set(schedule.semesterId, {
                                    semesterId: schedule.semesterId,
                                    semesterName: `Học kỳ ${semesterMap.size + 1}`,
                                    startDate: null,
                                    endDate: null,
                                    sessions: []
                                });
                            }
                            
                            // Thêm session date vào danh sách
                            if (schedule.SessionDate || schedule.sessionDate) {
                                const sessionDate = new Date(schedule.SessionDate || schedule.sessionDate);
                                semesterMap.get(schedule.semesterId).sessions.push(sessionDate);
                            }
                        }
                    });
                    
                    // Tính toán startDate và endDate cho mỗi học kỳ
                    for (const semester of semesterMap.values()) {
                        if (semester.sessions.length > 0) {
                            semester.startDate = new Date(Math.min(...semester.sessions));
                            semester.endDate = new Date(Math.max(...semester.sessions));
                            delete semester.sessions;  // Xóa mảng sessions không cần thiết nữa
                        }
                    }
                    
                    // Chuyển Map thành mảng và sắp xếp
                    const semesters = Array.from(semesterMap.values())
                        .filter(s => s.startDate && s.endDate)  // Chỉ giữ lại các học kỳ có ngày
                        .sort((a, b) => a.startDate - b.startDate);
                    
                    // Hiển thị học kỳ
                    displaySemesters(semesters);
                    return;
                }
                
                console.warn("Không tìm thấy dữ liệu lịch học, thử phương pháp khác");
                await extractSemestersFromSchedule();
                
            } catch (error) {
                console.error('Error fetching semesters:', error);
                await extractSemestersFromSchedule();
            }
        }
        
        // Hiển thị học kỳ trong dropdown
        function displaySemesters(semesters) {
            if (!semesters || semesters.length === 0) {
                semesterSelect.innerHTML = '<option value="">Không có học kỳ</option>';
                return;
            }
            
            // Chuyển đổi định dạng học kỳ
            const formattedSemesters = semesters.map(semester => {
                const startDate = new Date(semester.startDate);
                const endDate = new Date(semester.endDate);
                
                // Xác định năm học dựa trên startDate
                const schoolYear = startDate.getMonth() < 8 
                    ? `${startDate.getFullYear()-1}-${startDate.getFullYear()}`
                    : `${startDate.getFullYear()}-${startDate.getFullYear()+1}`;
                
                // Thêm thông tin học kỳ, năm học
                return {
                    ...semester,
                    schoolYear,
                    formattedName: `Học kỳ ${semester.semesterName || semester.semesterId} (${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')})`,
                    startYear: startDate.getFullYear(),
                    semester: parseInt(semester.semesterName?.replace(/\D/g, '') || '1')
                };
            });
            
            // Sắp xếp học kỳ theo năm học và số thứ tự học kỳ
            formattedSemesters.sort((a, b) => {
                // Ưu tiên sắp xếp theo năm bắt đầu
                if (a.startYear !== b.startYear) {
                    return a.startYear - b.startYear;
                }
                // Nếu cùng năm thì sắp xếp theo học kỳ (số)
                return a.semester - b.semester;
            });
            
            let semesterOptions = '<option value="">Chọn học kỳ</option>';
            const now = new Date();
            let currentSemesterFound = false;
            
            formattedSemesters.forEach(semester => {
                const startDate = new Date(semester.startDate);
                const endDate = new Date(semester.endDate);
                
                // Định dạng lại tên hiển thị của học kỳ
                const semesterDisplay = `Học kỳ ${semester.semester} năm học ${semester.schoolYear}`;
                
                // Kiểm tra học kỳ hiện tại
                const isCurrent = startDate <= now && now <= endDate;
                if (isCurrent) currentSemesterFound = true;
                
                semesterOptions += `<option value="${semester.semesterId}" ${isCurrent ? 'selected' : ''}>${semesterDisplay}</option>`;
            });
            
            semesterSelect.innerHTML = semesterOptions;
            
            // Nếu không tìm thấy học kỳ hiện tại, chọn học kỳ mới nhất
            if (!currentSemesterFound && formattedSemesters.length > 0) {
                const latestSemester = formattedSemesters[formattedSemesters.length - 1];
                const options = Array.from(semesterSelect.options);
                for (const option of options) {
                    if (option.value === latestSemester.semesterId) {
                        option.selected = true;
                        break;
                    }
                }
            }
        }
        
        // Lấy danh sách học kỳ
        async function fetchSemesters() {
            try {
                // Đầu tiên thử lấy danh sách học kỳ từ API
                const response = await fetch(`${API_BASE_URL}/api/schedules/semesters`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                // Nếu API thất bại, sử dụng phương pháp khác (trích xuất từ dữ liệu lịch học)
                if (!response.ok || !result.success || !result.data || result.data.length === 0) {
                    console.log('Không thể lấy danh sách học kỳ từ API, sẽ trích xuất từ dữ liệu lịch học');
                    await extractSemestersFromSchedule();
                    return;
                }
                
                // Cập nhật danh sách học kỳ
                const semesters = result.data || [];
                let semesterOptions = '<option value="">Tất cả học kỳ</option>';
                
                semesters.forEach(semester => {
                    const startDate = new Date(semester.startDate);
                    const endDate = new Date(semester.endDate);
                    const semesterInfo = `${semester.semesterName} (${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')})`;
                    
                    semesterOptions += `<option value="${semester.semesterId}">${semesterInfo}</option>`;
                });
                
                semesterSelect.innerHTML = semesterOptions;
                
            } catch (error) {
                console.error('Error fetching semesters:', error);
                // Nếu gặp lỗi, thử phương pháp trích xuất từ lịch học
                await extractSemestersFromSchedule();
            }
        }
        
        // Trích xuất thông tin học kỳ từ dữ liệu lịch học
        async function extractSemestersFromSchedule() {
            try {
                // Nếu chưa có dữ liệu lịch học, lấy về trước
                if (!originalScheduleData) {
                    await fetchUserSchedule();
                    if (!originalScheduleData) return;
                }
                
                // Lấy danh sách học kỳ từ dữ liệu lịch học
                const semesterMap = new Map();
                
                originalScheduleData.schedules.forEach(schedule => {
                    if (schedule.semesterId) {
                        // Nếu chưa có thông tin học kỳ này, thêm vào Map
                        if (!semesterMap.has(schedule.semesterId)) {
                            // Lấy ngày bắt đầu và kết thúc từ lịch học
                            const sessions = originalScheduleData.schedules
                                .filter(s => s.semesterId === schedule.semesterId)
                                .map(s => new Date(s.SessionDate || s.sessionDate));
                            
                            const startDate = sessions.length > 0 ? new Date(Math.min(...sessions)) : new Date();
                            const endDate = sessions.length > 0 ? new Date(Math.max(...sessions)) : new Date();
                            
                            semesterMap.set(schedule.semesterId, {
                                semesterId: schedule.semesterId,
                                semesterName: `Học kỳ ${semesterMap.size + 1}`,
                                startDate,
                                endDate
                            });
                        }
                    }
                });
                
                // Chuyển Map thành mảng và sắp xếp theo ngày bắt đầu
                const semesters = Array.from(semesterMap.values()).sort((a, b) => 
                    new Date(a.startDate) - new Date(b.startDate)
                );
                
                // Cập nhật select box
                let semesterOptions = '<option value="">Tất cả học kỳ</option>';
                
                semesters.forEach((semester, index) => {
                    const startDate = new Date(semester.startDate);
                    const endDate = new Date(semester.endDate);
                    const semesterInfo = `${semester.semesterName} (${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')})`;
                    
                    // Kiểm tra xem đây có phải là học kỳ hiện tại không
                    const now = new Date();
                    const isCurrent = startDate <= now && now <= endDate;
                    
                    semesterOptions += `<option value="${semester.semesterId}" ${isCurrent ? 'selected' : ''}>${semesterInfo}</option>`;
                });
                
                semesterSelect.innerHTML = semesterOptions;
                
            } catch (error) {
                console.error('Error extracting semesters:', error);
                semesterSelect.innerHTML = '<option value="">Không thể tải học kỳ</option>';
            }
        }
        
        // Tính toán tuần hiện tại trong học kỳ
        function getCurrentWeek(semester) {
            if (!semester || !semester.startDate) return 1;
            
            const start = new Date(semester.startDate);
            const now = new Date();
            
            // Nếu thời gian hiện tại trước khi bắt đầu học kỳ
            if (now < start) return 1;
            
            // Tính số ngày giữa hai ngày
            const diffTime = Math.abs(now - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Tính số tuần (làm tròn lên)
            return Math.ceil(diffDays / 7);
        }
        
        // Cập nhật hiển thị tuần khi thay đổi học kỳ
        semesterSelect.addEventListener('change', function() {
            const selectedSemesterId = this.value;
            
            if (!selectedSemesterId) {
                // Nếu chọn "Tất cả học kỳ", hiển thị tuần mặc định
                const today = new Date();
                const weekNum = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / 604800000);
                scheduleWeekInput.value = weekNum;
                return;
            }
            
            // Tìm học kỳ được chọn
            let selectedSemester = null;
            
            // Trích xuất options từ select box
            const options = Array.from(semesterSelect.options);
            for (const option of options) {
                if (option.value === selectedSemesterId) {
                    // Trích xuất thông tin ngày từ text
                    const text = option.textContent;
                    const dateMatch = text.match(/\(([^)]+)\)/);
                    
                    if (dateMatch && dateMatch[1]) {
                        const dates = dateMatch[1].split(' - ');
                        if (dates.length === 2) {
                            selectedSemester = {
                                semesterId: selectedSemesterId,
                                semesterName: text.split('(')[0].trim(),
                                startDate: parseVietnameseDate(dates[0]),
                                endDate: parseVietnameseDate(dates[1])
                            };
                        }
                    }
                    break;
                }
            }
            
            if (selectedSemester) {
                // Tính tuần hiện tại trong học kỳ
                const currentWeek = getCurrentWeek(selectedSemester);
                scheduleWeekInput.value = currentWeek;
            }
        });
        
        // Hàm phân tích ngày theo định dạng tiếng Việt
        function parseVietnameseDate(dateStr) {
            // Định dạng ngày/tháng/năm
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            }
            return new Date();
        }
        
        // Hiển thị lịch học và học kỳ hiện tại khi tải trang
        async function loadCurrentScheduleAndSemester() {
            // Nếu chưa có dữ liệu lịch học, lấy về
            if (!originalScheduleData) {
                await fetchUserSchedule();
                if (!originalScheduleData) return;
            }
            
            // Trích xuất học kỳ hiện tại từ dữ liệu
            const now = new Date();
            const semesters = [];
            
            // Tạo Map để lưu thông tin học kỳ
            const semesterMap = new Map();
            
            originalScheduleData.schedules.forEach(schedule => {
                if (schedule.semesterId && !semesterMap.has(schedule.semesterId)) {
                    // Lọc tất cả các buổi học của học kỳ này
                    const sessionsInSemester = originalScheduleData.schedules
                        .filter(s => s.semesterId === schedule.semesterId)
                        .map(s => new Date(s.SessionDate || s.sessionDate));
                    
                    if (sessionsInSemester.length > 0) {
                        const startDate = new Date(Math.min(...sessionsInSemester));
                        const endDate = new Date(Math.max(...sessionsInSemester));
                        
                        semesterMap.set(schedule.semesterId, {
                            semesterId: schedule.semesterId,
                            startDate,
                            endDate,
                            isCurrent: startDate <= now && now <= endDate
                        });
                    }
                }
            });
            
            // Chuyển Map thành mảng
            const semesterArray = Array.from(semesterMap.values());
            
            // Tìm học kỳ hiện tại
            const currentSemester = semesterArray.find(s => s.isCurrent);
            
            if (currentSemester) {
                // Tính tuần hiện tại
                const currentWeek = getCurrentWeek(currentSemester);
                
                // Hiển thị thông tin
                const infoHtml = `
                    <div class="current-info">
                        <p><strong>Học kỳ hiện tại:</strong> Học kỳ (${currentSemester.startDate.toLocaleDateString('vi-VN')} - ${currentSemester.endDate.toLocaleDateString('vi-VN')})</p>
                        <p><strong>Tuần hiện tại:</strong> Tuần ${currentWeek}</p>
                    </div>
                `;
                
                // Hiển thị thông tin ở đầu danh sách lịch học
                const infoDiv = document.createElement('div');
                infoDiv.className = 'semester-info';
                infoDiv.innerHTML = infoHtml;
                
                // Chèn vào đầu container
                if (scheduleContainer.firstChild) {
                    scheduleContainer.insertBefore(infoDiv, scheduleContainer.firstChild);
                } else {
                    scheduleContainer.appendChild(infoDiv);
                }
            }
        }
        
        // Tải danh sách học sinh (cho phụ huynh)
        function loadStudentList(user) {
            if (user.role !== 'Parent' || !user.children || user.children.length === 0) {
                studentSelect.innerHTML = '<option value="">Không có học sinh</option>';
                return;
            }
            
            let studentOptions = '<option value="">Chọn học sinh</option>';
            user.children.forEach(student => {
                studentOptions += `<option value="${student.studentId}">${student.fullName}</option>`;
            });
            
            studentSelect.innerHTML = studentOptions;
        }
        
        // Hiển thị lịch học
        function displaySchedule(data) {
            console.log('Displaying schedule data:', data);
            
            // Kiểm tra xem có dữ liệu lịch không
            // Check for different possible data structures
            let scheduleData = [];
            
            if (Array.isArray(data)) {
                // Direct array of schedules
                scheduleData = data;
            } else if (data && data.schedules && Array.isArray(data.schedules)) {
                // Object with schedules array
                scheduleData = data.schedules;
            } else if (data && data.schedule && Array.isArray(data.schedule)) {
                // Object with schedule array (different naming)
                scheduleData = data.schedule;
            }
            
            if (scheduleData.length === 0) {
                scheduleContainer.innerHTML = '<p>Không có lịch học nào</p>';
                return;
            }
            
            // Nhóm lịch học theo ngày
            const schedulesByDay = {};
            
            scheduleData.forEach(schedule => {
                // Kiểm tra và xử lý ngày học
                let date;
                if (schedule.SessionDate) {
                    date = new Date(schedule.SessionDate);
                } else if (schedule.sessionDate) {
                    date = new Date(schedule.sessionDate);
                } else if (schedule.date) {
                    date = new Date(schedule.date);
                } else {
                    console.warn('No date found in schedule:', schedule);
                    return; // Bỏ qua nếu không có ngày
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date in schedule:', schedule);
                    return; // Bỏ qua nếu ngày không hợp lệ
                }
                
                const day = date.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                if (!schedulesByDay[day]) {
                    schedulesByDay[day] = [];
                }
                
                schedulesByDay[day].push(schedule);
            });
            
            // Lấy thông tin về role từ data
            const userRole = data.role || "";
            
            // Sắp xếp các ngày theo thứ tự thời gian
            const sortedDays = Object.keys(schedulesByDay).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            
            // Hiển thị lịch học theo ngày
            let html = '';
            
            // Hiển thị thông tin học kỳ nếu có
            if (data.semester) {
                html += `<div class="semester-info">
                    <h3>Học kỳ: ${data.semester.semesterName || 'Không xác định'}</h3>
                    <p>Từ ngày: ${data.semester.startDate ? new Date(data.semester.startDate).toLocaleDateString('vi-VN') : 'Chưa xác định'}</p>
                    <p>Đến ngày: ${data.semester.endDate ? new Date(data.semester.endDate).toLocaleDateString('vi-VN') : 'Chưa xác định'}</p>
                </div>`;
            }
            
            // Hiển thị thông tin người dùng phù hợp với vai trò
            if (userRole === "Teacher") {
                html += `<div class="user-schedule-info">
                    <p><strong>Giáo viên:</strong> ${data.user && data.user.fullName ? data.user.fullName : 'Không xác định'}</p>
                    <p><strong>Bộ môn:</strong> ${data.user && data.user.major ? data.user.major : 'Không xác định'}</p>
                </div>`;
            } else if (userRole === "Student") {
                html += `<div class="user-schedule-info">
                    <p><strong>Học sinh:</strong> ${data.user && data.user.fullName ? data.user.fullName : 'Không xác định'}</p>
                    <p><strong>Lớp:</strong> ${data.user && data.user.classId ? data.user.classId : 'Không xác định'}</p>
                </div>`;
            }
            
            // Add message if exists
            if (data.message) {
                html += `<div class="user-schedule-info">
                    <p><strong>Thông báo:</strong> ${data.message}</p>
                </div>`;
            }
            
            sortedDays.forEach(day => {
                html += `<div class="schedule-day">
                    <h3>${day}</h3>`;
                
                // Sắp xếp tiết học theo thời gian
                const sortedSchedules = schedulesByDay[day].sort((a, b) => {
                    const slotA = a.SlotID || a.slotId || a.periodNumber || 0;
                    const slotB = b.SlotID || b.slotId || b.periodNumber || 0;
                    return slotA - slotB;
                });
                
                sortedSchedules.forEach(schedule => {
                    // Lấy các thông tin quan trọng, với fallback để tương thích với nhiều định dạng
                    const subjectId = schedule.subjectId || "";
                    const subjectName = schedule.subjectName || `Môn học ${subjectId}`;
                    
                    const classId = schedule.classId || "";
                    const className = schedule.className || `Lớp ${classId}`;
                    
                    const teacherId = schedule.teacherId || "";
                    const teacherName = schedule.teacherName || (userRole === "Teacher" ? data.user.fullName : `Giáo viên ${teacherId}`);
                    
                    const roomId = schedule.classroomId || "";
                    const roomNumber = schedule.classroomNumber || schedule.roomNumber || `Phòng ${roomId}`;
                    
                    const slotId = schedule.SlotID || schedule.slotId || schedule.periodNumber || "N/A";
                    const startTime = schedule.startTime || "N/A";
                    const endTime = schedule.endTime || "N/A";
                    const topic = schedule.topic || "Chưa cập nhật";
                    
                    html += `<div class="schedule-item">
                        <p><strong>Tiết ${slotId}:</strong> ${subjectName} (${startTime} - ${endTime})</p>
                        <p><strong>Giáo viên:</strong> ${teacherName}</p>
                        <p><strong>Phòng:</strong> ${roomNumber}</p>
                        <p><strong>Lớp:</strong> ${className}</p>
                        <p><strong>Chủ đề:</strong> ${topic}</p>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            scheduleContainer.innerHTML = html;
        }
        
        // Hiển thị lịch học dạng bảng
        function displayScheduleTable(data) {
            advancedScheduleResult.classList.add('hidden');
            
            // Log data to console for debugging
            console.log('Schedule Data Raw:', data);
            
            // Handle different response formats
            let scheduleData = null;
            let userInfo = '';
            
            // Case 1: If data is an array directly (daily schedule format)
            if (Array.isArray(data)) {
                scheduleData = data;
                console.log('Case 1: Data is array with', scheduleData.length, 'items');
            } 
            // Case 2: If data has a schedules property
            else if (data && data.schedules && Array.isArray(data.schedules)) {
                scheduleData = data.schedules;
                console.log('Case 2: Data has schedules property with', scheduleData.length, 'items');
                
                // Get user info if available
                if (data.user) {
                    if (data.role === 'Teacher') {
                        userInfo = `<p><strong>Giáo viên:</strong> ${data.user.fullName || 'Không xác định'}</p>
                                   <p><strong>Bộ môn:</strong> ${data.user.major || 'Không xác định'}</p>`;
                    } else if (data.role === 'Student') {
                        userInfo = `<p><strong>Học sinh:</strong> ${data.user.fullName || 'Không xác định'}</p>
                                   <p><strong>Lớp:</strong> ${data.user.classId || 'Không xác định'}</p>`;
                    }
                }
            }
            // Case 3: If data has a schedule property
            else if (data && data.schedule && Array.isArray(data.schedule)) {
                scheduleData = data.schedule;
                console.log('Case 3: Data has schedule property with', scheduleData.length, 'items');
            }
            // Case 4: Handle message property (common in 'Found X schedules' responses)
            else if (data && data.message && typeof data.message === 'string' && data.message.includes('schedules')) {
                // Extract user information from the message if possible
                userInfo = `<p><strong>Thông báo:</strong> ${data.message}</p>`;
                
                if (Array.isArray(data.schedules)) {
                    scheduleData = data.schedules;
                    console.log('Case 4: Data with message and schedules array with', scheduleData.length, 'items');
                }
            }
            // Case 5: Handle nested data structure in API response
            else if (data && typeof data === 'object' && data.data) {
                if (Array.isArray(data.data)) {
                    scheduleData = data.data;
                    console.log('Case 5a: Data is nested in data array with', scheduleData.length, 'items');
                }
                else if (data.data.schedules && Array.isArray(data.data.schedules)) {
                    scheduleData = data.data.schedules;
                    console.log('Case 5b: Data is nested in data.schedules with', scheduleData.length, 'items');
                    
                    // Add week range info if available
                    if (data.data.weekRange) {
                        userInfo += `<p><strong>Tuần:</strong> ${data.data.weekRange}</p>`;
                    }
                    
                    // Get user info
                    if (data.data.user) {
                        if (data.data.role === 'Teacher') {
                            userInfo += `<p><strong>Giáo viên:</strong> ${data.data.user.fullName || 'Không xác định'}</p>
                                       <p><strong>Bộ môn:</strong> ${data.data.user.major || 'Không xác định'}</p>`;
                        } else if (data.data.role === 'Student') {
                            userInfo += `<p><strong>Học sinh:</strong> ${data.data.user.fullName || 'Không xác định'}</p>
                                       <p><strong>Lớp:</strong> ${data.data.user.classId || 'Không xác định'}</p>`;
                        }
                    }
                }
            }
            
            // Check if we have any schedule data
            if (!scheduleData || scheduleData.length === 0) {
                advancedScheduleResult.innerHTML = '<p>Không có lịch học nào</p>';
                advancedScheduleResult.classList.remove('hidden');
                return;
            }
            
            // Display user information if available
            if (userInfo) {
                advancedScheduleResult.innerHTML = userInfo;
                advancedScheduleResult.classList.remove('hidden');
            } else {
                advancedScheduleResult.innerHTML = `<p>Tìm thấy ${scheduleData.length} lịch học</p>`;
                advancedScheduleResult.classList.remove('hidden');
            }
            
            scheduleTableBody.innerHTML = '';
            
            // Sắp xếp lịch học theo ngày và tiết
            const sortedSchedules = [...scheduleData].sort((a, b) => {
                // Sắp xếp theo ngày
                const dateA = a.SessionDate || a.sessionDate || '';
                const dateB = b.SessionDate || b.sessionDate || '';
                if (dateA !== dateB) {
                    return dateA.localeCompare(dateB);
                }
                
                // Nếu cùng ngày, sắp xếp theo tiết
                const slotA = a.SlotID || a.slotId || a.periodNumber || a.period || 0;
                const slotB = b.SlotID || b.slotId || b.periodNumber || b.period || 0;
                return slotA - slotB;
            });
            
            // Log lịch học đã sắp xếp
            console.log('Sorted Schedules:', sortedSchedules);
            
            sortedSchedules.forEach(schedule => {
                const row = document.createElement('tr');
                
                // Lấy các thông tin quan trọng với fallback để tương thích với nhiều định dạng
                const slotId = schedule.SlotID || schedule.slotId || schedule.periodNumber || schedule.period || "N/A";
                
                // Handle subject data which could be in different formats
                let subjectName = schedule.subjectName || (schedule.subject ? schedule.subject.name : '') || `Môn học ${schedule.subjectId || ''}`;
                let teacherName = schedule.teacherName || (schedule.teacher ? schedule.teacher.name : '') || `Giáo viên ${schedule.teacherId || ''}`;
                let roomName = schedule.classroomNumber || schedule.roomNumber || 
                              (schedule.classroom ? schedule.classroom.room : '') || 
                              `Phòng ${schedule.classroomId || ''}`;
                let className = schedule.className || `Lớp ${schedule.classId || ''}`;
                
                // Extract date information
                let sessionDate = 'N/A';
                let dayOfWeek = 'N/A';
                
                if (schedule.SessionDate) {
                    sessionDate = new Date(schedule.SessionDate).toLocaleDateString('vi-VN');
                    dayOfWeek = new Date(schedule.SessionDate).toLocaleDateString('vi-VN', { weekday: 'long' });
                } else if (schedule.sessionDate) {
                    sessionDate = new Date(schedule.sessionDate).toLocaleDateString('vi-VN');
                    dayOfWeek = new Date(schedule.sessionDate).toLocaleDateString('vi-VN', { weekday: 'long' });
                } else if (schedule.date) {
                    sessionDate = new Date(schedule.date).toLocaleDateString('vi-VN');
                    dayOfWeek = new Date(schedule.date).toLocaleDateString('vi-VN', { weekday: 'long' });
                }
                
                // Use dayOfWeek from schedule if available
                if (schedule.dayOfWeek) {
                    dayOfWeek = translateDayOfWeek(schedule.dayOfWeek);
                }
                
                const topic = schedule.topic || schedule.Topic || "Chưa cập nhật";
                
                row.innerHTML = `
                    <td>${slotId} <small>(${schedule.startTime || 'N/A'} - ${schedule.endTime || 'N/A'})</small></td>
                    <td>${subjectName}</td>
                    <td>${teacherName}</td>
                    <td>${roomName}</td>
                    <td>${sessionDate} <small>(${dayOfWeek})</small></td>
                    <td>${topic}</td>
                `;
                
                scheduleTableBody.appendChild(row);
            });
            
            scheduleTable.classList.remove('hidden');
        }
        
        // Helper function to translate day of week
        function translateDayOfWeek(day) {
            const translations = {
                'Monday': 'Thứ hai',
                'Tuesday': 'Thứ ba',
                'Wednesday': 'Thứ tư',
                'Thursday': 'Thứ năm',
                'Friday': 'Thứ sáu',
                'Saturday': 'Thứ bảy',
                'Sunday': 'Chủ nhật'
            };
            
            return translations[day] || day;
        }
        
        // Chuyển đổi vai trò sang tiếng Việt
        function translateRole(role) {
            const roles = {
                'Admin': 'Quản trị viên',
                'Teacher': 'Giáo viên',
                'Student': 'Học sinh',
                'Parent': 'Phụ huynh'
            };
            
            return roles[role] || role;
        }
        
        // Mô tả vai trò
        function getRoleDescription(role) {
            const descriptions = {
                'Admin': 'Quản lý toàn bộ hệ thống',
                'Teacher': 'Quản lý lớp học và dạy học sinh',
                'Student': 'Học sinh tham gia lớp học',
                'Parent': 'Phụ huynh theo dõi con em'
            };
            
            return descriptions[role] || '';
        }
        
        // Xử lý tabs
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Kích hoạt tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Hiển thị tab content
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            });
        });
        
        // Đặt ngày mặc định cho input date là hôm nay
        const today = new Date();
        const formattedDate = today.toISOString().substr(0, 10);
        scheduleDateInput.value = formattedDate;
        
        // Đặt tuần mặc định là tuần hiện tại (ước lượng)
        const weekNum = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / 604800000);
        scheduleWeekInput.value = weekNum;

        // Xử lý nút lọc lịch học
        filterScheduleBtn.addEventListener('click', function() {
            if (!originalScheduleData) return;
            
            const searchTerm = scheduleSearch.value.toLowerCase();
            const filterDate = scheduleFilterDate.value ? new Date(scheduleFilterDate.value) : null;
            
            // Tạo bản sao dữ liệu gốc để lọc
            const filteredData = {...originalScheduleData};
            
            // Lọc danh sách lịch học
            if (searchTerm || filterDate) {
                filteredData.schedules = originalScheduleData.schedules.filter(schedule => {
                    // Lọc theo từ khóa tìm kiếm
                    let matchesSearch = true;
                    if (searchTerm) {
                        const subjectName = `Môn học ${schedule.subjectId}`;
                        const teacherName = `Giáo viên ${schedule.teacherId}`;
                        const className = `Lớp ${schedule.classId}`;
                        const roomName = `Phòng ${schedule.classroomId}`;
                        
                        matchesSearch = 
                            subjectName.toLowerCase().includes(searchTerm) ||
                            teacherName.toLowerCase().includes(searchTerm) ||
                            className.toLowerCase().includes(searchTerm) ||
                            roomName.toLowerCase().includes(searchTerm) ||
                            (schedule.dayOfWeek && schedule.dayOfWeek.toLowerCase().includes(searchTerm));
                    }
                    
                    // Lọc theo ngày
                    let matchesDate = true;
                    if (filterDate) {
                        const scheduleDate = new Date(schedule.SessionDate || schedule.sessionDate || schedule.date || null);
                        
                        if (scheduleDate && !isNaN(scheduleDate.getTime())) {
                            // So sánh năm, tháng, ngày (không quan tâm đến giờ)
                            matchesDate = 
                                scheduleDate.getFullYear() === filterDate.getFullYear() &&
                                scheduleDate.getMonth() === filterDate.getMonth() &&
                                scheduleDate.getDate() === filterDate.getDate();
                        } else {
                            matchesDate = false;
                        }
                    }
                    
                    return matchesSearch && matchesDate;
                });
            }
            
            // Hiển thị dữ liệu đã lọc
            displaySchedule(filteredData);
        });

        // Xử lý nút đặt lại bộ lọc
        resetFilterBtn.addEventListener('click', function() {
            scheduleSearch.value = '';
            scheduleFilterDate.value = '';
            
            if (originalScheduleData) {
                displaySchedule(originalScheduleData);
            }
        });

        const weekRangeFilter = document.getElementById('week-range-filter');
        const scheduleWeekRangeInput = document.getElementById('schedule-week-range');
        const getCurrentWeekBtn = document.getElementById('get-current-week-btn');

        // Lấy tuần hiện tại
        getCurrentWeekBtn.addEventListener('click', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules/current-week`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Không thể lấy thông tin tuần hiện tại');
                }
                
                // Đặt giá trị cho input
                scheduleWeekRangeInput.value = result.data.weekRange;
                
            } catch (error) {
                console.error('Error fetching current week:', error);
                alert(`Lỗi: ${error.message}`);
            }
        });

        // Add event listener for the debug button
        document.getElementById('debug-daily-schedule').addEventListener('click', async function() {
            const date = document.getElementById('schedule-date').value;
            if (!date) {
                alert('Vui lòng chọn ngày');
                return;
            }
            
            try {
                const endpoint = `/api/schedules/daily/${date}`;
                console.log('Debug: Calling API endpoint:', endpoint);
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Debug: API Status Code:', response.status);
                console.log('Debug: Response Headers:', [...response.headers].reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {}));
                
                const result = await response.json();
                console.log('Debug: API Response:', result);
                
                // Show in alert for immediate feedback
                alert(`API Status: ${response.status}\nSuccess: ${result.success}\nData Count: ${result.data && result.data.schedules ? result.data.schedules.length : 'N/A'}`);
                
            } catch (error) {
                console.error('Debug: API Error:', error);
                alert(`Debug Error: ${error.message}`);
            }
        });

        // Add handler for test-daily-api button if not already defined
        document.getElementById('test-daily-api').addEventListener('click', async function() {
            const debugResponse = document.getElementById('debug-response');
            const debugCallInfo = document.getElementById('debug-call-info');
            
            debugCallInfo.innerHTML = '<p>Testing Daily Schedule API...</p>';
            
            const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
            
            try {
                const endpoint = `/api/schedules/daily/${today}`;
                debugCallInfo.innerHTML += `<p>Endpoint: ${endpoint}</p>`;
                
                const start = performance.now();
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const end = performance.now();
                
                debugCallInfo.innerHTML += `<p>Response Time: ${(end - start).toFixed(2)}ms</p>`;
                debugCallInfo.innerHTML += `<p>Status: ${response.status} ${response.statusText}</p>`;
                
                const result = await response.json();
                debugResponse.textContent = JSON.stringify(result, null, 2);
                
                // Additional debug info
                if (result.data) {
                    if (Array.isArray(result.data)) {
                        debugCallInfo.innerHTML += `<p>Data: Array[${result.data.length}]</p>`;
                    } else if (result.data.schedules) {
                        debugCallInfo.innerHTML += `<p>Data: Object with schedules[${result.data.schedules.length}]</p>`;
                    } else {
                        debugCallInfo.innerHTML += `<p>Data: Object (no schedules array)</p>`;
                    }
                }
                
            } catch (error) {
                debugCallInfo.innerHTML += `<p class="error">Error: ${error.message}</p>`;
                debugResponse.textContent = error.stack || error.message;
            }
        });

        // Add handler for test-weekly-api button
        document.getElementById('test-weekly-api').addEventListener('click', async function() {
            const debugResponse = document.getElementById('debug-response');
            const debugCallInfo = document.getElementById('debug-call-info');
            
            debugCallInfo.innerHTML = '<p>Testing Weekly Schedule API...</p>';
            
            try {
                // First get the current week
                const weekResponse = await fetch(`${API_BASE_URL}/api/schedules/current-week`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!weekResponse.ok) {
                    throw new Error('Không thể lấy thông tin tuần hiện tại');
                }
                
                const weekResult = await weekResponse.json();
                const currentWeek = weekResult.data.weekRange;
                
                debugCallInfo.innerHTML += `<p>Current Week: ${currentWeek}</p>`;
                
                // Now try to get the weekly schedule
                const endpoint = `/api/schedules/week-range/${encodeURIComponent(currentWeek)}`;
                debugCallInfo.innerHTML += `<p>Endpoint: ${endpoint}</p>`;
                
                const start = performance.now();
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const end = performance.now();
                
                debugCallInfo.innerHTML += `<p>Response Time: ${(end - start).toFixed(2)}ms</p>`;
                debugCallInfo.innerHTML += `<p>Status: ${response.status} ${response.statusText}</p>`;
                
                const result = await response.json();
                debugResponse.textContent = JSON.stringify(result, null, 2);
                
                // Analyze the response
                if (result.success) {
                    const schedulesCount = result.data && result.data.schedules ? result.data.schedules.length : 0;
                    debugCallInfo.innerHTML += `<p style="color: green">✅ API trả về ${schedulesCount} lịch học cho tuần ${currentWeek}</p>`;
                    
                    // Count by day of week if available
                    if (schedulesCount > 0) {
                        const dayCount = {};
                        result.data.schedules.forEach(schedule => {
                            const day = schedule.dayOfWeek || 'Unknown';
                            dayCount[day] = (dayCount[day] || 0) + 1;
                        });
                        
                        // Display count by day
                        debugCallInfo.innerHTML += '<p>Số lịch học theo ngày:</p><ul>';
                        for (const [day, count] of Object.entries(dayCount)) {
                            debugCallInfo.innerHTML += `<li>${day}: ${count}</li>`;
                        }
                        debugCallInfo.innerHTML += '</ul>';
                    }
                } else {
                    debugCallInfo.innerHTML += `<p style="color: red">❌ Lỗi: ${result.message || 'Lỗi không xác định'}</p>`;
                }
                
            } catch (error) {
                debugCallInfo.innerHTML += `<p class="error">Error: ${error.message}</p>`;
                debugResponse.textContent = error.stack || error.message;
            }
        });

        // Add handler for the SessionWeek field check button
        document.getElementById('check-sessionweek-field').addEventListener('click', async function() {
            const debugResponse = document.getElementById('debug-response');
            const debugCallInfo = document.getElementById('debug-call-info');
            
            debugCallInfo.innerHTML = '<p>Kiểm tra trường SessionWeek trong database...</p>';
            
            try {
                // Query the current week for easy testing
                const weekResponse = await fetch(`${API_BASE_URL}/api/schedules/current-week`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!weekResponse.ok) {
                    throw new Error('Không thể lấy thông tin tuần hiện tại');
                }
                
                const weekResult = await weekResponse.json();
                const currentWeek = weekResult.data.weekRange;
                
                debugCallInfo.innerHTML += `<p>Tuần hiện tại: ${currentWeek}</p>`;
                
                // Attempt to query schedules by week range
                const scheduleResponse = await fetch(`${API_BASE_URL}/api/schedules/week-range/${encodeURIComponent(currentWeek)}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const scheduleResult = await scheduleResponse.json();
                
                // Display the result
                debugResponse.textContent = JSON.stringify(scheduleResult, null, 2);
                
                // Analyze the response
                const schedulesCount = scheduleResult.data && scheduleResult.data.schedules ? scheduleResult.data.schedules.length : 0;
                
                if (schedulesCount > 0) {
                    debugCallInfo.innerHTML += `<p style="color: green">✅ API trả về ${schedulesCount} lịch học với SessionWeek = "${currentWeek}"</p>`;
                    
                    // Add info about found schedules
                    const scheduleIds = scheduleResult.data.schedules.map(s => s.scheduleId || s._id).join(', ');
                    debugCallInfo.innerHTML += `<p>Schedule IDs: ${scheduleIds.substring(0, 100)}${scheduleIds.length > 100 ? '...' : ''}</p>`;
                } else {
                    debugCallInfo.innerHTML += `<p style="color: orange">⚠️ API không tìm thấy lịch học nào với SessionWeek = "${currentWeek}"</p>`;
                    debugCallInfo.innerHTML += `<p>Có thể trường SessionWeek chưa được thiết lập đúng trong database.</p>`;
                    debugCallInfo.innerHTML += `<p>Hãy thử sử dụng nút "Fix SessionWeek Field" để cập nhật.</p>`;
                }
                
                // Also check for SessionDate field in the same date range
                const { startDate, endDate } = scheduleService.parseWeekRange(currentWeek);
                if (startDate && endDate) {
                    const startDateStr = startDate.toISOString().substr(0, 10);
                    const endDateStr = endDate.toISOString().substr(0, 10);
                    
                    debugCallInfo.innerHTML += `<p>Đang kiểm tra lịch học theo SessionDate từ ${startDateStr} đến ${endDateStr}...</p>`;
                    
                    // Use our new debug endpoint
                    const dateRangeResponse = await fetch(`${API_BASE_URL}/api/schedules/debug/date-range?start=${startDateStr}&end=${endDateStr}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (!dateRangeResponse.ok) {
                        throw new Error('Không thể kiểm tra lịch học theo khoảng ngày');
                    }
                    
                    const dateRangeResult = await dateRangeResponse.json();
                    
                    const dateRangeCount = dateRangeResult.data ? dateRangeResult.data.length : 0;
                    if (dateRangeCount > 0) {
                        debugCallInfo.innerHTML += `<p style="color: green">✅ Tìm thấy ${dateRangeCount} lịch học trong khoảng ngày (${dateRangeResult.meta.withSessionWeek} có trường SessionWeek, ${dateRangeResult.meta.withoutSessionWeek} không có)</p>`;
                        
                        if (dateRangeResult.meta.withoutSessionWeek > 0) {
                            debugCallInfo.innerHTML += `<p style="color: orange">⚠️ Có ${dateRangeResult.meta.withoutSessionWeek} lịch học không có trường SessionWeek - cần cập nhật!</p>`;
                            debugCallInfo.innerHTML += `<p>Hãy sử dụng nút "Fix SessionWeek Field" để cập nhật trường SessionWeek.</p>`;
                        }
                    } else {
                        debugCallInfo.innerHTML += `<p style="color: red">❌ Không tìm thấy lịch học nào trong khoảng ngày ${startDateStr} đến ${endDateStr}</p>`;
                    }
                    
                    // Update the debug response display
                    debugResponse.textContent = JSON.stringify(dateRangeResult, null, 2);
                }
            } catch (error) {
                console.error('Error checking SessionWeek field:', error);
                debugCallInfo.innerHTML += `<p class="error">Error: ${error.message}</p>`;
                debugResponse.textContent = error.stack || error.message;
            }
        });

        // Thêm vào phần ngay sau khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo danh sách tuần với năm hiện tại
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('schedule-year');
            if (yearSelect) {
                yearSelect.value = currentYear;
                initWeekDropdown(currentYear);
            }
            
            // Khởi tạo các handler sự kiện khác nếu cần
            const scheduleTypeSelect = document.getElementById('schedule-type');
            scheduleTypeSelect.dispatchEvent(new Event('change'));
        });

        // Khởi tạo danh sách tuần cho dropdown
        function initWeekDropdown(year) {
            try {
                const weekDropdown = document.getElementById('schedule-week-dropdown');
                if (!weekDropdown) return;
                
                const weeks = generateWeeksForYear(year);
                
                let options = '';
                const currentDate = new Date();
                
                weeks.forEach((week, index) => {
                    const startDate = new Date(week.start);
                    const endDate = new Date(week.end);
                    
                    // Kiểm tra xem tuần hiện tại là tuần nào
                    const isCurrentWeek = currentDate >= startDate && currentDate <= endDate;
                    
                    options += `<option value="${index + 1}" data-start="${week.start}" data-end="${week.end}" ${isCurrentWeek ? 'selected' : ''}>
                        Tuần ${index + 1}: ${formatDate(startDate)} đến ${formatDate(endDate)}
                    </option>`;
                });
                
                weekDropdown.innerHTML = options;
            } catch (error) {
                console.error('Error initializing week dropdown:', error);
            }
        }

        // Tạo danh sách các tuần trong năm
        function generateWeeksForYear(year) {
            const weeks = [];
            const firstDayOfYear = new Date(year, 0, 1);
            
            // Tìm ngày thứ hai đầu tiên của năm
            let firstMonday = new Date(firstDayOfYear);
            while (firstMonday.getDay() !== 1) { // 1 là thứ hai
                firstMonday.setDate(firstMonday.getDate() + 1);
            }
            
            // Tạo danh sách 52 tuần bắt đầu từ thứ hai đầu tiên
            let currentMonday = new Date(firstMonday);
            
            for (let i = 0; i < 52; i++) {
                const startDate = new Date(currentMonday);
                const endDate = new Date(currentMonday);
                endDate.setDate(endDate.getDate() + 6); // Chủ nhật = thứ 2 + 6 ngày
                
                // Tạo SessionWeek string theo đúng format "YYYY-MM-DD to YYYY-MM-DD"
                const startStr = startDate.toISOString().split('T')[0];
                const endStr = endDate.toISOString().split('T')[0];
                const sessionWeek = `${startStr} to ${endStr}`;
                
                // Debug
                if (i < 3 || i > 48) {
                    console.log(`Tuần ${i+1}: ${sessionWeek}`);
                }
                
                weeks.push({
                    start: startStr,
                    end: endStr,
                    sessionWeek: sessionWeek  // Thêm trường này để dễ truy cập
                });
                
                // Chuyển sang thứ hai tuần tiếp theo
                currentMonday.setDate(currentMonday.getDate() + 7);
            }
            
            return weeks;
        }

        // Format ngày dạng dd/MM
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}`;
        }

        // Debug Weekly Schedule API
        document.getElementById('get-current-week-debug').addEventListener('click', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules/current-week`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Không thể lấy thông tin tuần hiện tại');
                }
                
                // Đặt giá trị cho input
                document.getElementById('debug-week-range').value = result.data.weekRange;
                
                // Show the week range details
                document.getElementById('debug-weekly-result').innerHTML = `
                    <div class="result">
                        <p><strong>Current Week Range:</strong> ${result.data.weekRange}</p>
                        <p><strong>Week Start:</strong> ${new Date(result.data.weekStart).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Week End:</strong> ${new Date(result.data.weekEnd).toLocaleDateString('vi-VN')}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching current week:', error);
                document.getElementById('debug-weekly-result').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        });

        document.getElementById('test-week-range-api').addEventListener('click', async function() {
            const weekRange = document.getElementById('debug-week-range').value;
            if (!weekRange) {
                alert('Vui lòng nhập hoặc chọn khoảng tuần để kiểm tra');
                return;
            }
            
            const debugWeeklyResult = document.getElementById('debug-weekly-result');
            const debugResponse = document.getElementById('debug-response');
            const debugCallInfo = document.getElementById('debug-call-info');
            
            debugWeeklyResult.innerHTML = '<p>Đang kiểm tra API lịch học theo tuần...</p>';
            debugCallInfo.innerHTML = `<p>Testing Week Range API for: "${weekRange}"</p>`;
            
            try {
                const endpoint = `/api/schedules/week-range/${encodeURIComponent(weekRange)}`;
                
                debugCallInfo.innerHTML += `<p>Endpoint: ${endpoint}</p>`;
                
                const start = performance.now();
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const end = performance.now();
                
                debugCallInfo.innerHTML += `<p>Response Time: ${(end - start).toFixed(2)}ms</p>`;
                debugCallInfo.innerHTML += `<p>Status: ${response.status} ${response.statusText}</p>`;
                
                const result = await response.json();
                debugResponse.textContent = JSON.stringify(result, null, 2);
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'API trả về lỗi');
                }
                
                // Display success information
                const schedulesCount = result.data && result.data.schedules ? result.data.schedules.length : 0;
                
                debugWeeklyResult.innerHTML = `
                    <div class="result">
                        <p><strong>Success:</strong> API trả về ${schedulesCount} lịch học cho tuần ${weekRange}</p>
                        <p><strong>User Role:</strong> ${result.data.role || 'Không xác định'}</p>
                    </div>
                `;
                
                // Show more detailed information about the schedules
                if (schedulesCount > 0) {
                    let scheduleInfo = '<div class="schedule-table"><table border="1">';
                    scheduleInfo += `<tr><th>Ngày</th><th>Tiết</th><th>Môn học</th><th>Giáo viên</th><th>Phòng</th></tr>`;
                    
                    result.data.schedules.forEach(schedule => {
                        const date = schedule.sessionDate || schedule.SessionDate || 'N/A';
                        const period = schedule.SlotID || schedule.slotId || schedule.period || 'N/A';
                        const subjectName = schedule.subjectName || `Môn học ${schedule.subjectId || ''}`;
                        const teacherName = schedule.teacherName || `Giáo viên ${schedule.teacherId || ''}`;
                        const roomName = schedule.classroomNumber || schedule.roomNumber || `Phòng ${schedule.classroomId || ''}`;
                        
                        scheduleInfo += `<tr>
                            <td>${date}</td>
                            <td>${period}</td>
                            <td>${subjectName}</td>
                            <td>${teacherName}</td>
                            <td>${roomName}</td>
                        </tr>`;
                    });
                    
                    scheduleInfo += '</table></div>';
                    debugWeeklyResult.innerHTML += scheduleInfo;
                }
            } catch (error) {
                console.error('Error testing weekly API:', error);
                debugWeeklyResult.innerHTML = `<div class="error">${error.message}</div>`;
            }
        });

        document.getElementById('fix-session-week').addEventListener('click', async function() {
            // This requires admin privileges
            const weekRange = document.getElementById('debug-week-range').value;
            if (!weekRange) {
                alert('Vui lòng nhập hoặc chọn khoảng tuần để sửa');
                return;
            }
            
            const debugWeeklyResult = document.getElementById('debug-weekly-result');
            debugWeeklyResult.innerHTML = '<p>Đang gửi yêu cầu sửa SessionWeek...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules/check-week/${encodeURIComponent(weekRange)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Lỗi khi sửa SessionWeek');
                }
                
                debugWeeklyResult.innerHTML = `
                    <div class="result">
                        <p><strong>Kết quả:</strong> ${result.message}</p>
                        <p><strong>Đã cập nhật:</strong> ${result.data.schedulesUpdated} lịch học</p>
                        <p><strong>Tuần:</strong> ${result.data.weekRange}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error fixing SessionWeek:', error);
                debugWeeklyResult.innerHTML = `<div class="error">${error.message}</div>`;
            }
        });

        // Xử lý thay đổi năm
        document.getElementById('schedule-year').addEventListener('change', function() {
            initWeekDropdown(parseInt(this.value));
        });
    </script>
</body>
</html> 